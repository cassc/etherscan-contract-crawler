// SPDX-License-Identifier: MIT

//
//                                         .....+ggNNNNNNNNgggJ(....
//                                  ...gMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNa+..
//                             ..+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNJ..
//                          .&MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMa,.
//                   `  ..MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMa,.
//                    .dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNJ.
//        `  `     ..MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNJ.
//               .JMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN,
//              (MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNJ
//    `      `.MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMe.
//        ` .dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMa
//         .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN,
//        .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN,  `  `  `  `  `  `  `  `  `  `  `  `  `  `
//    `  .MMMMMMMMMMMMMMMMY"HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMp
//      .MMMMMMMMMMMMMM"`         ?""MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//     .MMMMMMMMMMMMD`                  ?"MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN,
//    `dMMMMMMMMMM"      `                  ?WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMe  `  `  `  `  `  `  `  `  `  `  `  `
//    .MMMMMMMMM3      `    `  `  `    .JMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMp
//    JMMMMMMM#...                     MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMp                                    `
//    MMMMMMMMMMMMMm.                  UMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//    MMMMMMMMMMMMMM#      `   `        (YMMMMMMMMMMM$.TMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.   `  `  `  `  `  `  `  `  `  `
//    MMMMMMMMMMMMMMF   `         `         _7"""""^    .WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN
//    [email protected]'                                      (MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMp
//    MMMM#                  `                              7MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//    dMMMF               `     `   `                        .HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN
//    (MMMN           `                                        7MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//    .MMMN                             `                       ,MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//     dMMM[             `   `              `                     WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//     .MMMN.        `          `   `           `                  UMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//      ,MMMb                                       `               TMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//       JMMMb          `  `           ..gMMMMMMMNgJ,     `          7MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN
//        4MMMNgMMMMMMMMNg,.   `  ` .MM"`.M#` WMMMMMMMNx...g%         ?MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//         MMMMb .#  dMMMMMM`      ,MN,. .MM&.MMMMMMM:.dM9^     `      TMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//         (MMMM;.MN+MMMM#=          .THNg-MMMMMMMMMMM9^                UMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN
//         ,MMMMb .MMMB=                   ?7"""""7!                     WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM]
//         .MMMMMP7`            `                                  `     .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//    `    .MMMMM\           .,                                 `         ,MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//         .MMMMM`           M:                                            JMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM|
//         .MMMMF        `  .M      `                         `             MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//         JMMMM%           dF                                       `      ,MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//         MMMM#           .M%   `    TMa.                  `                dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//        .MMMM%      `    .M`          UN,   `                   `           MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN
//    `   JMMM#          ` d#     (MMMe  ?M,      `     `              `      -MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM]
//        MMMMF            Mh....(MMMMMN-.M%                                   MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//       .MMMM:             _!??!!~```                        `            `   -MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//       -MMM#       `                    ..          `           `             MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM[
//       dMMMF          `          .&g, .dMMN, .,         `            `        JMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//       MMMM]                 .N,.MMMMMMMMMMMM#`   `                           .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//       MMMM]                  .WMMMMMMMMMMMMM\              `      `           HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMc
//      .MMMM]       `  `  `      (MM"MMMMM"[email protected]                   `        `     -MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//      .MMMM]                     ,WNM&...JMD          `                        .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//      .MMMM]                        _7"""!      `         `                     MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//      .MMMMF       `      `  `                                       `     `    JMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN
//       MMMMN           `        `                   `         `                 ,MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//       dMMMM|                                                    `       `      .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMc
//    `  .MMMMN       `                         `         `                        MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//       .MMMMMb           `  `  `                  `         `        `           dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//       (MMMMMMp                                                              `   JMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//       MMMMMMMMp   `  `             `     `                      `               -MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMx
//      .MMMMMMMMMR                  .............gM"!  `                  `       ,MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//      dMMMMMMMMMMN,      `  `  `     ~???????!`           `   `      `           .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//     .MMMMMMMMMMMMMm,                                                        `   .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN.
//     JMMMMMMMMMMMMMMMm,                                                          .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMR
//    .MMMMMMMMMMMMMMMMMMNa,                                       `       `       ,MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb
//    -MMMMMMMMMMMMMMMMMMMMMMNJ,.   `                     `   `        `       ..gMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMp
//   .MMMMMMMMMMMMMMMMMMMMMMMMMMMMNa+...          `   `                  ...gMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM[
//   (MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNNg+......       ` ......JgMMMMMMMMMMMM"MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//  .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMH9"!  .dMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM,
//  JMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMg/7"""HMMMMMMMMMMMMMMMMM""""!`      ..MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN,
// .MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM7WMMMMMMNg,.                          ..gMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN
// ,"""WMMMMMM""7777???!!~```          .TMMMMMMMMMNg...             ....gMMMMMMMMMMMMMMMMMMMMMMMMHHHHHHHHHH""""""""""""""""""""""""HMMMMMM"""""""""""^
//    .MMMMMM!                            ."WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM9^                                                   ,MMMMM[
//   .MMMMMM^                                  ?TWMMMMMMMMMMMMMMMMMMMMMMMH""`                                                        dMMMMN
//   dMMMMM$                                          ??7""""""""""7?`                                                               .MMMMM[
//  ”Shikibu-chan" - copyright belongs to BUSON

pragma solidity ^0.8.7;

import "@openzeppelin/contracts/token/ERC1155/extensions/ERC1155Supply.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/access/AccessControl.sol";
import "@openzeppelin/contracts/utils/Strings.sol";
import "./interface/ITokenURI.sol";
import "./Base64.sol";


contract SKBThanks is ERC1155Supply, Ownable, AccessControl {

    function supportsInterface(bytes4 interfaceId) public view virtual 
        override(AccessControl,ERC1155) returns (bool) {
        return
        interfaceId == type(IAccessControl).interfaceId ||
        interfaceId == type(IERC1155).interfaceId ||
        super.supportsInterface(interfaceId);
    }
    uint256 public maxSupply = 500;
    // Contract name
    string public name;
    // Contract symbol
    string public symbol;
    ITokenURI public tokenuri;
    
    bytes32 public constant ADMIN = keccak256("ADMIN");
    // Mapping from account to message
    mapping (uint256 => string) nftcomment;
    mapping (uint256 => string) nftimage;
    mapping (uint256 => string) mintedtime;
    mapping (address => uint256) nfttransfercount;
    mapping (address => uint256) nftmintcount;

    string constant rl1='data:application/json;base64,';
    string constant rl2='{"name": "Kansha Kangeki SKB Soul bound NFT';
    string constant rl3='", "description": "';
    string constant rl4='", "image": "';
    string constant tr1='", "attributes": [{"trait_type": "Thanks","value": "MAX"},{"trait_type": "Encouraged","value": "MAX';
    string constant tr2='"},{"trait_type": "Minted Time","value": "';
    string constant tr3='"}]}';
    string constant date="2023/1/";


    constructor(string memory _name, string memory _symbol, string memory uri_)
        ERC1155(uri_) {
        name = _name;
        symbol = _symbol;
        _grantRole(ADMIN,0x1b632c9a883DF07A18d4b2813840E029bEceFf6D);
        _grantRole(ADMIN,0x480d565527086DC3dc2262648194E1e9cCAB70EF);
        _grantRole(ADMIN,0x3FFcb00bE71F4a0Aa2d8624fBA4e97203FA3EA3B);
        _grantRole(ADMIN,0xf3CfAD477A0f8443b0b6E81BF7A4a1fF7B69D46f);
        _grantRole(ADMIN,0x0dAE5FcaD0DF8E5C029D76927582DFBdFd7eeC79);
    }

    ////////// modifiers //////////
    modifier onlyAdminOrOwner() {
        require(
            owner() == _msgSender() || hasRole(ADMIN, msg.sender),
            "caller is not the admin"
        );
        _;
    }


    // additional mint by owner or admin
    function adminMint(address _to, uint256 _id, uint256 _amount) external onlyAdminOrOwner {
        require(tx.origin == msg.sender, "Cannot mint from contracts");
        require(balanceOf(_to, _id) == 0, "Cannot mint more than 1 NFT");
        require(_amount == 1, "mintAmount is not 1");
        _mint(_to, _id, _amount,"");
        nftmintcount[_to] += 1; 
    }

    // airdrop mint by owner or admin
    function airdropMint(address[] memory _tos , uint256 _id, uint256[] memory _amounts) external onlyAdminOrOwner {
        require(tx.origin == msg.sender, "Cannot mint from contracts");
        uint256 _amount = 0;
        string memory minttime = getCurrentTime();
        for (uint256 i = 0; i < _amounts.length; i++) {
        _amount += _amounts[i];
        }
        require(_amount > 0, "need to mint at least 1 NFT");
        require(totalSupply(_id) + _amount <= maxSupply, "max NFT limit exceeded");
        require(_tos.length == _amounts.length, "array length unmuch");
        for (uint256 i = 0; i < _amounts.length; i++) {
        mintedtime[_id] = minttime;
        _mint(_tos[i], _id, _amounts[i],"");
        nftmintcount[_tos[i]] += 1; 
        }
    }

    // get current time (JST)
    function getCurrentTime() public view returns (string memory){
        // base time is 2022/12/24 00:00:00 (JST) = 1671807600
        uint256 basetime = block.timestamp - 1671807600;
        uint256 day = (basetime / 86400 ) % 365 -7;
        uint256 hour = (basetime / 3600 ) % 24;
        uint256 min = (basetime  / 60 ) % 60;
        uint256 sec = basetime  % 60;
        return string(abi.encodePacked(date, Strings.toString(day), " - ", Strings.toString(hour),":",Strings.toString(min),":",Strings.toString(sec)));
    }


    // Just to check function this cannot exactly transfer
//    function transfer(address from, address to, uint256 id, uint256 amount) public onlyAdminOrOwner {
//        require(tx.origin == msg.sender, "Cannot mint from contracts");
//        require(to != address(0), "ERC1155: mint to the zero address");
//        _safeTransferFrom(from, to, id, amount,"");
//    }

    // this is non transferable
    function _beforeTokenTransfer(
        address operator,
        address from,
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
        ) internal virtual override(ERC1155Supply) {
        if (nfttransfercount[from] == 1 ) {
            require(from == address(0) || to == address(0), "NonTransferrableERC1155Token: non transferrable");
            super._beforeTokenTransfer(operator, from, to, ids, amounts, data);
        } else {
            super._beforeTokenTransfer(operator, from, to, ids, amounts, data);
        }
        if (nftmintcount[from] == 1 ) {
            nfttransfercount[from] += 1; 
            nfttransfercount[to] += 1; 
        } 
    }

    // burn by token owner
    function burn(address _from, uint256 _id, uint256 _amount) external {
        require(tx.origin == msg.sender, "Cannot burn from contracts");
        require(balanceOf(msg.sender, _id) == 1, "Caller should be NFT owner by id and have 1 NFT");
        require(msg.sender == _from, "Caller should burn own NFT, not other one's");
        require(_amount == 1, "burn amount should be 1");
        _burn(_from, _id, _amount);
    }

// approval function
    function setApprovalForAll(address operator, bool approved) public virtual override {
        require(tx.origin == msg.sender, "Cannot burn from contracts");
        require(msg.sender == address(0), "Cannot list this NFT");
        _setApprovalForAll(_msgSender(), operator, approved);
    }
   
    // mapping functions to set Attirbution and nft information
    function nftTransferCountOf() public view returns (uint256) {
        return nfttransfercount[msg.sender];
    }

    function nftMintCountOf() public view returns (uint256) {
        return nftmintcount[msg.sender];
    }

    function mintedTimeOf(uint256 id) public view returns (string memory) {
        return mintedtime[id];
    }

    function setNftCommentandImage(uint256 _nftids, string memory _comment, string memory _image) public onlyOwner {
        nftcomment[_nftids] = _comment;
        nftimage[_nftids] = _image;
    }

    function nftCommentOf(uint256 id) public view returns (string memory) {
        return nftcomment[id];
    }

    function nftImageOf(uint256 id) public view returns (string memory) {
        return nftimage[id];
    }


    // Attribution setting
    function getAttributes(uint256 id) public virtual view returns(string memory) {
        return string(abi.encodePacked(rl2,rl3,nftcomment[id],rl4,nftimage[id]));
    }

    // refer the latest uri for token id
    function uri(uint256 id) public view override returns (string memory) {
        if (address(tokenuri) != address(0)) {
            return tokenuri.tokenURI(id);
        } else {
            return string(abi.encodePacked(rl1,Base64.encode(bytes(string(abi.encodePacked(getAttributes(id),tr1,tr2,mintedtime[id],tr3))))));
        }
    }

    function setTokenURI(ITokenURI _tokenuri) external onlyAdminOrOwner{
        tokenuri = _tokenuri;
    }

    // set name and symbol by only owner
    function setnameandsymbol(string memory newname, string memory newsymbol) public onlyOwner {
        name = newname;
        symbol = newsymbol;
    }

    // set newOwner by only owner
    function transferOwnership(address newOwner) public virtual override onlyOwner {
        require(newOwner != address(0), "Ownable: new owner is the zero address");
        _transferOwnership(newOwner);
    }


    // avoid renounce owner to 0x000... by only owner
    function renounceOwnership() public override onlyOwner {
        _transferOwnership(address(msg.sender));
    }

}