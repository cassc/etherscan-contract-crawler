/**
 *   .......................................';,..'lkOxxxkOx:'..:;........................................
 *   ....................,xl.................';..:KMMMMMMMW0,.,,..................,;.....................
 *   ..................;cxkkl:;...............';..lXMMMMMMK:.;,..............''..,:c;....................
 *   .................lxlxKOoxx,...............,:..:0WMMWO,.;:...............,;ccclldl,,.................
 *   .................';,lKx;,'...............',',..,ONNx'.',;,...............,o0000OOd;..,;.............
 *   ..................':kxxd::;.............,'......'co;......;'.........';cd0XNNNNNXKxlc;..............
 *   ...............,odooxxxxodkxc..........',.......:kKOc......,........,,'c0XNNWWWNNXXOl;,;'...........
 *   ..............;kOx,.;OKc..dOx;.......';........lOl'l0o......;,....'.';cd0XNWMWWMWXKOl:,,............
 *   ..............':cl:.,0Nl.;c;,........,'......'dk;';';kx,.....''........cKNNNWWWWNXNOc...............
 *   .................';.:XMk'..........;;.......,xd':0NO;'dk;.....;;....';;cdOKKXXXXXNKc,;,'............
 *   ....................dNNX:..........'.......:kl.:dk0xo:.lOl......,'......:dkkxOO0Odkc................
 *   ...................;kocko'.......;,.......lO:.cl:okxcll.:Od......;'....',;;;,;',:.,:................
 *   ...........''....';xklc,'......',.......'dk;'lc:o;.,occl',kk,.....,,...'.....;c:,;......',,,'.......
 *   ......,;;:ooc::lclol0Nd'.......;'......,kx''oc:o,...'lcco'.dO:.....,........,dXXdc:,,::::ldl:::,....
 *   ....,ll:;,c:',:ldd;:o;.......,,.......cOo.,o:co,......ll:o;.lOl.....';........,dd;cxdl::,:o;':llc,..
 *   ...:c:cl;.:;.,co::xl........''.......ok:.;o;l0c.......,Od;o:.:Od'....''.........''::'::c:co''cl::o;.
 *   ..;c,;'.,;ol;'.':;oc.......;,......,xx,.:l;lodc.......;dol:oc.,kk,.....;'........,l;;'.,lkkc;'.:;lo.
 *   ..cdc:;;;cOk:,,;lcoc.....',.......:Oo.'ll:oc.ll.......:l.:o:ll,,dOc.....,'.......;dc::;;ck0d:;;llod'
 *   ..;c',,.',cc,'.,;;l,....';....,;:dKk:lkl:o;..cl.......cl..;o:lklc0Xdcc;..,,......'l;';.''cl,,.':;cl.
 *   ...c:'cdc':;.:l:;c;....,'.....cXWXd,:o::o,...co. .....ll...,o::l,cKWWKc...',......,locc:.:l';lc:cc..
 *   ....,ccc:;lc;::::'....,;......cKXdlxOlcl'....lkl:::::ckl....'lloOdlkXk;.....;,......clll;lo:cccc,...
 *   ......';;;cc;;,.....,;.......cOocccloOOl..'ccokc.....ckdc:..'lOklo:;:lOc.....,'.......,;;::;;;......
 *   ...................';.......oOc..lo,ll;cloo:..o:.....:o'.:ool;,lc,o:..:Oo.....;;....................
 *   ..................:,......'xO;..lc,ll...:d'...ll.....lc...,d:...cc,lc..;kd'.....'...................
 *   .................''......,kx,.'dd:dx;;,ckd;:::dOdodoxOo;;;;dkc;:lkolOl..,xk,....';'.................
 *   ...............',.......;Od..;odk0d:;;;lkl;;;;;oXMMMXo,,,,,cxl,:dxkkcol..'xO;.....',................
 *   ..............,........:Oo..:o,'kO'....'o;......lXMNl......;d,..;o:lc.:o'..oOc.....,,...............
 *   .............,,.......lOc..:o'.l0d......co.......oXx'.....'o:....o:.oc.:o,..cOl......;,.............
 *   ...........,;........dk;..ll..lcco'......co,.....:ko.....:o:.....lc..ol.;o,..:Od'.....''............
 *   ...........'.......'xx,..ll..ll..oc.......,cc:,..:ko'.;clc'.....,o;...ol.;d;..,kk,.....;;...........
 *   .........;;.......,kd'.'oc..ol...:ko........';:::d0kc::,........dk;....ll.,o:..'xO;......''.........
 *   .......','.......:Oo..,o:..oc..:cc:cl:...........cOo..........,lc;:c:,..co.'oc...oOc.....';.........
 *   ......':,.......lOc..;o;.'do:oxd:,,,:dxo;,;,,,,,,o0d;,,,;;;,cdko::;cdOxlcxd..ol...cOl.......,.......
 *   .....;:........dk;..:o,.'kKdllc:::::::clclkko:::;d0x:;;cokxlc::;;;;;;;::lxx:..ll...:Od......,,......
 *   ....;;.......'xx,..co'.:oo;................,'....:Ol....;;................,:c:,co,..,kx'......,,....
 *   ...:;.......;kd...lxlloc,.................''.....l0d,.'.''''''...''''''''''',codkk:..'xk,......;,...
 *   .':,.......:kl...;oddoc:::::::::::::::::::::::clcdKklol::::::::::::cccccccccccclooc....oO:......;:..
 *   ,:'.......:00xddddddddoooooooooooooooooloolloldkk0NKOOxlllllllllllllllllllllllllllloollo0Kc......''.
 *   :.........',,,,,,,,,,'','''','','',,,,,,,,,,;,,,oXMNx;,;;;;;:;;;;::::::::::::::::ccccccccc;........,
 *   ,.','.',..';,'.;;..;,..,.''.'.''.''.'.''.'.',....:xl....''.',.','''.'.''.''.,.''.'.',.'''..,,..''..;
 *   ...........,d:.l:.ol.......................,'...........,...........................................
 *   ...........'ol:kx:oc.................;dl::c00l;:ldxl:;ckKo::cxx,.................'coddolc'..........
 *   ............c::Ox,::..................ld,.lxkd'.:KMk'.lkkd'.cd;.................;kKkocldOOc.........
 *   ............cc:kd;l;...................cddccx0kclddxlokxddddl'..................xKk:.;',d0k,........
 *   ...............oc......................,k0:,llkXo. ;00:;llO0;..................;OOc:;';;cOO:........
 *   ...............oc.....................;xl;dl.:odxoldooo,cxccx:.................:Kk',:;;.;O0:........
 *   ...............oc....................c0x:;lO0Ol;dXWk;:kK0o;:d0c................:Kk;lO0kcl0x'........
 *   ...............oc....................;c:::::dOodOdokxoOxc:c::c;.................d0xdxkxdx0l.........
 *   ...............ox:ld,........................cxd;..'dkl.........................'lxkOOOkd:..........
 *   ...............oxcdx;.........................ll....;l'............................;clc,............

 */
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.17;

import "./RitualBindings.sol";

error MarkedByGuardian(uint256 tokenId);
error ReachingBeyondAbility();
error Unphased();
error Impostor();
error AlreadyInscribed();
error UnacceptableOffering(uint256 cost, uint256 amount);
error ElderAlreadyClaimed(uint256 elder);


contract RiteOfTheGuardian is RitualBindings {    

    uint256 constant UNDEAD_KEY = 0;
    uint256 constant MORTAL_KEY = 1;

    uint256 inscriptionCost = .05 ether;

    mapping(string => uint256[]) scribe;

    constructor(string memory invocation, string memory seal) RitualBindings(invocation,seal) {}

    function pactWithCharun(address pact) external onlyOwner {
        invokeCharun(pact);        
    }        

    function pactWithElders(address pact) external onlyOwner {
        consumeElders(pact);
    }

    function pactOfSustenance(address pact) external onlyOwner {
        consumeBrainz(pact);
    }

    function bestowBountyOfCharun(address recipient, uint256 quantity) internal {
        
        uint256 bounty = quantity * 1000 * (10**18);
        if (ResidualBrainz(seekBrainz()).balanceOf(address(this)) > bounty) {
            ResidualBrainz(seekBrainz()).transfer(recipient,bounty);
        }
    }

    function elderRitual(uint64 quantity, uint256[] memory elders, bytes calldata sigil) external 
    requiresClaimSig(sigil,msg.sender,elders) {
        for (uint i = 0; i < elders.length; i++) {
            if (hasBeenClaimed(elders[i], findElders())) {
                revert ElderAlreadyClaimed(elders[i]);
            }
            
            claim(elders[i], findElders());
        }
        
        phasedMint(ELDER, quantity, false);
        
        bestowBountyOfCharun(msg.sender,quantity);

        markGuardian(ELDER,quantity);
    }  

    function initiateRitual(uint256 quantity, bytes calldata sigil) external 
    requiresAllowSig(sigil,msg.sender) {
        Phase memory phased = findPhase(INITIATE);
        
        giveCharunHisBrainz(phased.cost, quantity);
        
        phasedMint(INITIATE, quantity, false);

        markGuardian(INITIATE,quantity);
    }      

    function acolyteRitual(uint256 quantity, bytes calldata sigil) external payable
    requiresAllowSig(sigil,msg.sender) {
        Phase memory phased = findPhase(ACOLYTE);
        
        giveCharunHisCoin(phased.cost, quantity);
        
        phasedMint(ACOLYTE, quantity, false);

        bestowBountyOfCharun(msg.sender,quantity);

        markGuardian(ACOLYTE,quantity);
    }   

    function ritualPhase(uint256 quantity, uint256 phase) external payable {

        Phase memory phased = findPhase(phase);

        giveCharunHisCoin(phased.cost, quantity);

        phasedMint(phase, quantity, false);

        bestowBountyOfCharun(msg.sender,quantity);

        markGuardian(phase,quantity);  
    }  

    function necrophize(uint256 tokenId) public {
        if (!canTransform(NECRO)) {
            revert ReachingBeyondAbility();
        }
        validateApprovedOrOwner(msg.sender, tokenId);  

        setSupplemental(tokenId, true, UNDEAD_KEY);

        if (!enumerationExists(tokenId)) {
            enumerateToken(msg.sender, tokenId);
        }
    }
    function judgement(uint256 scriptClass,uint256 tokenId) private view {
        if (!canInscribe(scriptClass,tokenId)) {
            revert ReachingBeyondAbility();
        }
        if (inscriptionRequestExists(scriptClass,tokenId)) {
            revert AlreadyInscribed();
        }  
    }
    function necroscribe(uint256 tokenId, string memory btcAddress) external payable {
        judgement(NECRO,tokenId);
        necrophize(tokenId);
      
        
        giveCharunHisCoin(inscriptionCost,1);

        script(NECRO,tokenId,btcAddress);    
    }  

    function vitalize(uint256 tokenId) public {
        if (!canTransform(MORTAL)) {
            revert ReachingBeyondAbility();
        }
        validateApprovedOrOwner(msg.sender, tokenId);  

        setSupplemental(tokenId, false, UNDEAD_KEY);
    }   

    function vitascribe(uint256 tokenId, string memory btcAddress) external payable {
        judgement(MORTAL,tokenId);

        vitalize(tokenId);

        giveCharunHisCoin(inscriptionCost,1);

        script(MORTAL,tokenId,btcAddress);    
    }  


    function inscribe(string memory inscription, uint256 inscriptionClass, uint256 tokenId) external onlyOwner {
        inscript(inscription,inscriptionClass,tokenId);
    }

    function sacrifice(uint256 tokenId) external {

        validateApprovedOrOwner(msg.sender, tokenId);
        
        validateLock(tokenId);   

        if (enumerationExists(tokenId)) {
            enumerateBurn(msg.sender,tokenId);
            selfDestruct(tokenId);
        }

        packedBurn(tokenId);
    }  

    function isWorthyOffering(uint256 cost, uint256 quantity) internal view {        
        if (msg.value != (cost*quantity)) {
            revert UnacceptableOffering(cost*quantity, msg.value);
        }
    } 

    function giveCharunHisCoin(uint256 cost, uint256 quantity) internal {   
        isWorthyOffering(cost,quantity);           
        (summonCharun()).transfer(cost*quantity);
    }      
    function giveCharunHisBrainz(uint256 cost, uint256 quantity) internal {   
        ResidualBrainz(seekBrainz()).transferFrom(msg.sender, summonCharun(), quantity*cost*(10**18));          
    }
}

/**
 * Ordo Signum Machina - 2023
 */