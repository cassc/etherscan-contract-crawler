//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,..       
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.            
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.. ...                
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                           
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.                               
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                                  
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,                                   
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,(&%#(///((#@#,,,,,,,,,,,,,,,,,,,#@%(#&%,,,,,,,,,,,,,,,,,,,,,.                                  
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*&//#&&&&&&&&&%###@*,,,,,,,,,,,,,,%%(#@@@&#@/,,,,,,,,,,,,,,,,,,,,,,,,,.                            
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&###%&&&&&&&&&&&&&%###@,,,,,,,,,,,*@(/&@@@@&#&%,,,,,,,,,,,,,,,,,,,,,,,,,,,.                          
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&###&&&&&&&&&&&&&&&&&&###&#,,,,,,,,#&#(@@@@@&@%%&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.                 .,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*%((%&&&&#.....(&&&*,/.&&&&###@(,,,,,@##@@@@@@&&&@%@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,..  ..,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,&((#&&&&%...,,(&&*#&/../&&&&&&###%@%@##%@@@@@@&&&&&&&&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*&##&&&&&&%.,@&,,*.%&@,/@&&&&&&&&&#####%@@@@@@@&&&@&@@@&@*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,/%##&&&&&&&&&(,%&..(@&/,@&#/&&&&&&&&&&&&@@@@@@@@@@@@@@@@@&%@/,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,(%##&&&&&&&...*#/*,,....,(&&&&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@&##&@*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,####&&&&&&&@*..#&&&&%.,@&&&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@%&#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,%###&&&&&&&&&&&&&&&&%&@&&&&&&&&&&&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#####&&&&&&&&&&&&&&&&@&&&&@&&&@@@@@@@@@%%%##%%%&&@@@@@@@@@@@@@@@@@&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,/&%&&&%##%&&&&&&&&&&@@@@@@@@@@@@@@@@@%(((((((#@@@@((((((((%%%((&@@@@@@@%*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,/@@@&&&&&&&&&@@@@@@@@@@@@@@@@@@@@&((((((@@@@@%(((%@@@@%#@&&@@@&(((%@%*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,/@@@@@&@@@@@@@@@@@@@@@@@@@@@@@(((((((((@@@@@@@@&&@%(&@@@@@@@@@@@@(*&&&&%*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,/@@@@@@@@@@@@@@@@@@@@@@@@@@#(((((((((###(((%@@@&&***%&@@&(**/*(@@&*&&&&#%,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,#@@@@@@@@@@@@@@@@@@@@@@&&&&(((((((/(((.       /****%@@@&((*%@@@@*%&&&(,*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*%@@@@@@@@@@@@@@@@&&&@#((/******(,  (@@.    ***,*%@@@@@@&@@@@*/&&%*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*/(###(/*(&&&&(/*********(*  ,&/  ..***/////**,@@@@@@/*,&&/,,,,*((,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*###/*,%&%*************/((/////***/////////*,#@%*@@*,%/,*%/****(*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*&*,,,.,,,,,***************,*********//////////*,****/@&(#/***#%&(/#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*(#%%%&#
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*%.,*&#(#@/**********,************/(,*///////////*,/,/***#@/&*&/%&(((#,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*&&&&&&&@@@
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*/**(%//%%((@**/******************/,//////////////*,%((#/(((@@&*/(&#(&,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*%&&&&&&&&&
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,(***#**%(((&#**((/********/%(******(#/(@%%((//////**%%%#//*/(%@&/#&%%*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*&&&&&&&&&
//,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,*%******////***(((******/&&&%///**(%&&&&&&&&#((((//%&&&&%%&&&&&&&&%(,,,,,,,,,,,,,,,,,,,,,,,,,,,,,**/#&&@@@@&&&&&&&
//,*******************************,*****%************(((/*******%&&&&&&&&&&&&&&&&&&&%#(#&&&&&&&&&&&&&%&(**********************/#%&&&&&&&&&&@&&&%(%@&&&&&
//,**************************************%#*******/%&#(((/***/#*(((/(#%&&&&&%((///(///(///(#%#(&@(**/(/%************(%&&@@&@&@@&@&%(********************
//****************************************(/(#%#(,%&&&(((//****/%///////#@##(/**/////////////(,,%***/%((#/#%&&@@@@@@%#/*********************************
//****************************************/,**/%**/&%&(((///**(((///////***%*,,,,,****/*,,,. ,((&@@@@@@&&/**********************************************
//********************************(&*********///#&&%&&(#(///**/*#/////////***/#    .    .,##,,.(**///(#/&***********************************************
//****************************(@@&@@/******/%&&&&%&&&&#((((//**#*(/*////********///(%@@#  , .(**/((////(%***********************************************
//**************************/@@@&@@@%/****%%&&&%&&&&%%%#(/(////**/*/////********************/((((//////#(***********************************************
//***************#%%%%%#/*****%@@@@&&**#%%&&&&&&&&&&&%*###//(/////////////////*******////((((///#(/////&************************************************
//************/**#%&&&&&&&&%%&&&@@@&%@@@&&&%%&&&&(******###////(///////////////////////////////#//////(#************************************************
//************/%/*(&&&&&&&&&&%@@@@@@@@@&&&%(*************/&(/////#/(//#///#////////////////#////////(#/#/***********************************************
//***********/*%&#/*%&&%%/***/&@@@@&***********************(&///////////////(///////(////(#%%#/////(/#/*/%**********************************************
//**********(/*****%&%#******(@@@@@@&*************************&%((///////(///////((//(/**/(/(*/*%#(//(#/*((*********************************************
//*****************(%*************(&@%*************************(%(%&%(((%(//#///%//##////(//#/(/**////(/*(#*********************************************
//***********************************************************/(%%(((((#(#&%(((%////#///////(/////(//////(#**********************************************
//*********************************************************/%%%%%((((((#((((#&((((////(///////////(/(//&/***********************************************
//***************************************************/#%%&&&%%&@((((((((#/*****(&#((((##((#(((((((((%&%&%%/*******/*************************************
//********************************************/#&&&&&&&&&&&%%&##((/****************/%&%&%%####%&%&%%%%%%%%%%%%%%%%&//////*******************************
//***************************************/(&&%%%%%%&%%%%%%%%%#*****************************/(#%%%%%%%&%%%%%%%%%%&%############%#/***********************
//**********************************/%%##%###%%%%%%%%%%%%%%%&########%#%#%%%%%%%%%%%%%%%%%%%%%%%%(,     #%%%%%%%%%&&################/*******************
//*****************************/%%###########&%%*   ..%%%%%%(#%%%%##%#%%%%%%%%%%%%%%%%(/,                  (%%%%#, .(%############%###(*****************
//*********************/(%%###############&&&&%%&/...(%%%%%                                     .*/#%%%%%%%%%%%%&*...*&###########%%#####*******/*******
//**************(%%%######################&&&&%%%%%%%%%%%%%((//**,,,.....,,,**//((##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%########%%%%####%%%%%%%#%(*****
//************%%%%%%######################%&&&%%%%%%%%%%%&#########%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#(/,.     #%%%%%%%#######%&%%%####%%%%%%%###**/%
//***********(##%%%%%#####################%&&&%%,..*%%%%&###########%%%%%%%%%%%%%%%%%%%%%##/*,                     ,%%%,.. .#####%&%%%###%%%%%%%%##%#***
//***********(###%%%&%#####################&&&%/  ..*%%%                                                          .*/&%&@%*######%&&&%%#%%%%%%%%%%##%(**
//***********/%%%#%%&&&####################&&&%%%&&%%%%*,,...                       ....,,*/((###%%%%%%%%%%%%%%%%%%%%%%&%%%%%####%&&&%%%%%%%%%%%%%%##&**

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol";
import "@openzeppelin/contracts/utils/math/SafeMath.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/cryptography/draft-EIP712.sol";
import "@openzeppelin/contracts/utils/cryptography/SignatureChecker.sol";


// file ITransferController.sol
/**
 * @title Transfer controller interface
 * @dev Controller allows registering token transfers
 */
interface ITransferController {
    /**
     * @dev External controller to register token transfer
     */
    function onBeforeTokenTransfer(address msg_sender, address from, address to, uint256 tokenId) external;
}


// File: contracts/DrunkPirates.sol

/**
 * @title DrunkPirates contract
 * @dev Extends ERC721 Non-Fungible Token Standard basic implementation
 */
contract DrunkPirates is ERC721Enumerable, EIP712, Ownable {
    using SafeMath for uint256;

    string public DP_PROVENANCE = "";

    uint256 public startingIndexBlock;

    uint256 public startingIndex;

    uint256 public constant WhitelistPrice = 10000000000000000; //0.01 ETH
    
    uint256 public constant premintPrice = 15000000000000000; //0.015 ETH

    uint256 public constant mintPrice = 20000000000000000; //0.02 ETH

    uint public constant maxPiratePurchase = 20;

	uint256 public maxWhitelistPurshase = 2;
	
    uint256 public MAX_PIRATES;

    bool public saleIsActive = false;
	
    bool public mintWhitelistIsActive = false;

    bool public isPremint = true;

    bool public revealed = false;
	
	string private _baseTokenURI;

    uint256 public REVEAL_TIMESTAMP;

    uint256 public SALE_TIMESTAMP;

    address public TRANSFER_CONTROLLER;

    string public contractURI;

    string private _notRevealedURI;
	
	address private _list_signer = 0x9124B523827528Cef6d62963CD6C357f6De8a16e;
	
	mapping( address => uint256 ) private mintedAmount;

    constructor(string memory name, string memory symbol, uint256 maxNftSupply, uint256 saleStart) ERC721(name, symbol) EIP712("DRNPRT", "1.0.0") {
        MAX_PIRATES = maxNftSupply;
        REVEAL_TIMESTAMP = saleStart + (86400 * 7);
        SALE_TIMESTAMP = saleStart;
    }

    function withdraw() public onlyOwner {
        uint balance = address(this).balance;
        payable(msg.sender).transfer(balance);
    }

    /**
     * Set some Drunk Pirates aside
     */
    function reservePirates() public onlyOwner {        
        uint supply = totalSupply();
        uint i;
        for (i = 0; i < 30; i++) {
            _safeMint(msg.sender, supply + i);
        }
    }

    /**
     * Set reveal timestamp
     */
    function setRevealTimestamp(uint256 revealTimeStamp) public onlyOwner {
        REVEAL_TIMESTAMP = revealTimeStamp;
    } 

    /*     
    * Set provenance once it's calculated
    */
    function setProvenanceHash(string memory provenanceHash) public onlyOwner {
        DP_PROVENANCE = provenanceHash;
    }

    /*     
    * Set transfer controller
    */
    function setTransferController(address controller) public onlyOwner {
        TRANSFER_CONTROLLER = controller;
    }


    function setContractURI(string memory _contractURI) public onlyOwner {
        contractURI = _contractURI;
    }

    function setNotRevealedURI(string memory notRevealedURI) external onlyOwner {
        _notRevealedURI = notRevealedURI;
    }

    function reveal() external onlyOwner {
        revealed = !revealed;
    }

    /*
    * Pause sale if active, make active if paused
    */
    function flipSaleState() public onlyOwner {
        saleIsActive = !saleIsActive;
    }
	
	
    /*
    * Toggle WL, AL mint active/paused
    */
    function flipMintWhitelistState() public onlyOwner {
        mintWhitelistIsActive = !mintWhitelistIsActive;
    }	
	
	
    /*
    * Toggle premint / mint 
    */
    function flipPremintState() public onlyOwner {
        isPremint = !isPremint;
    }

	function _hash( address _account )
	internal view returns( bytes32 ) {
		return _hashTypedDataV4( keccak256( abi.encode( keccak256( "mintWithSignature(address)" ), _account ) ) );
	}	
	
	
    /**
    * Whitelist Mint
    */
    function mintWhitelist(uint _numberOfTokens,  bytes calldata _signature) public payable{
        require(block.timestamp <= SALE_TIMESTAMP, 'The whitelist mint has completed');
        require(mintWhitelistIsActive, "WL mint must be active to mint Pirate");
        require(_numberOfTokens <= maxWhitelistPurshase, "Can only mint 2 tokens per wallet");
        require(totalSupply().add(_numberOfTokens) <= MAX_PIRATES, "Purchase would exceed max supply of Pirates"); 
		uint256 _mintedAmount = mintedAmount[ msg.sender ];
		require( _mintedAmount + _numberOfTokens <= maxWhitelistPurshase, "Max per wallet reached" );
        require(WhitelistPrice.mul(_numberOfTokens) <= msg.value, "Ether value sent is not correct");
        bytes32 _digest = _hash( msg.sender);
		require(SignatureChecker.isValidSignatureNow(_list_signer, _digest, _signature ),  "INVALID SIGNATURE" );        
        for(uint i = 0; i < _numberOfTokens; i++) {
            uint mintIndex = totalSupply();
            if (totalSupply() < MAX_PIRATES) {
                _safeMint(msg.sender, mintIndex);
            }
        }	
		mintedAmount[ msg.sender ] = _mintedAmount + _numberOfTokens;
	}
	
	
    /**
    * Mint Drunk Pirates
    */
    function mintPirate(uint numberOfTokens) public payable {
        require(saleIsActive, "Sale must be active to mint Pirate");
        require(numberOfTokens <= maxPiratePurchase, "Can only mint 20 tokens at a time");
        require(totalSupply().add(numberOfTokens) <= MAX_PIRATES, "Purchase would exceed max supply of Pirates"); 
        uint price = (isPremint) ? premintPrice : mintPrice;
        require(price.mul(numberOfTokens) <= msg.value, "Ether value sent is not correct");
        
        for(uint i = 0; i < numberOfTokens; i++) {
            uint mintIndex = totalSupply();
            if (totalSupply() < MAX_PIRATES) {
                _safeMint(msg.sender, mintIndex);
            }
        }

        // If we haven't set the starting index and this is either 1) the last saleable token or 2) the first token to be sold after
        // the end of pre-sale, set the starting index block
        if (startingIndexBlock == 0 && (totalSupply() == MAX_PIRATES || block.timestamp >= REVEAL_TIMESTAMP)) {
            startingIndexBlock = block.number;
        } 
    }

	/**
	* Override _baseURI
	*/
	function _baseURI() internal view virtual override returns (string memory) {
		return _baseTokenURI;
	}

	function setBaseURI(string calldata newBaseTokenURI) public {
		_baseTokenURI = newBaseTokenURI;
	}

	function baseURI() public view returns (string memory) {
		return _baseURI();
	} 	
	
    /**
     * Set the starting index for the collection
     */
    function setStartingIndex() public {
        require(startingIndex == 0, "Starting index is already set");
        require(startingIndexBlock != 0, "Starting index block must be set");
        
        startingIndex = uint(blockhash(startingIndexBlock)) % MAX_PIRATES;
        // Just a sanity case in the worst case if this function is called late (EVM only stores last 256 block hashes)
        if (block.number.sub(startingIndexBlock) > 255) {
            startingIndex = uint(blockhash(block.number - 1)) % MAX_PIRATES;
        }
        // Prevent default sequence
        if (startingIndex == 0) {
            startingIndex = startingIndex.add(1);
        }
    }

    /**
     * Set the starting index block for the collection, essentially unblocking
     * setting starting index
     */
    function emergencySetStartingIndexBlock() public onlyOwner {
        require(startingIndex == 0, "Starting index is already set");
        
        startingIndexBlock = block.number;
    }


    function tokenURI(uint256 tokenId)
        public
        view
        virtual
        override
        returns (string memory)
    {
        require(
            _exists(tokenId),
            "ERC721Metadata: URI query for nonexistent token"
        );

        if (revealed == false) {
            return _notRevealedURI;
        }

        return super.tokenURI(tokenId);
    }



    /**
     * Transfer hook
     */    
    function _beforeTokenTransfer(
        address from,
        address to,
        uint256 tokenId
    ) internal virtual override(ERC721Enumerable) {
        super._beforeTokenTransfer(from, to, tokenId);
        if (TRANSFER_CONTROLLER != address(0)){
            address(TRANSFER_CONTROLLER).call{ value: 0 }(abi.encodeWithSelector(
                ITransferController(TRANSFER_CONTROLLER).onBeforeTokenTransfer.selector,
                _msgSender(),
                from,
                to,
                tokenId));
        }
    }

}