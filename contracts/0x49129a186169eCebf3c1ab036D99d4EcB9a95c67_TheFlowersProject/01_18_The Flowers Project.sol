// <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<▄<<<<<<<<<<<<<<<<!c<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<▌u<<<<<<<<<<<<<<<<<▌<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<!!<<<<<!▄▄▌▄▌▄☻▌▌▌▌▌▌▌▀▌▌▌▌▌▌▌▄▌▌▌▄▄J<<<<<<!<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<<!▀▀▄▌▌▌▌▌▌▌▌▌▀▀n<<<<<<<<<<<!▀▀▌▌▌▌▌▌▌▌▄▌▀n<<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<<!▄▌▀▌▌▌▌▌▀!<▀▌><<<<<<<<<<<<<▌▀<l▀▀▌▌▌▌▌▌▄J<<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<!▄▌▌▌▀▀▀▌<<<<<<<<!<<<<<<<<<<<<<<<<<<<<<▀▌▀▀▌▌▀▌c<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<y▌▀▌▌▀<<<<▌<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<▀<<<<▀▀▌▀▌▄<<<<<<<<<<<<<<
// <<<<<<<<<<<<!▌▌▌▀n<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<!▀▌▌▌▄<<<<<<<<<<<<
// <<<<<<@<<<<▄▌▌▀<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<▀▌▌▌><<<▄<<<<<<
// <<<<<<<▌▄y▌▌▌n<<<<<<<<<<<<<<<<<<<<<<<▄<<<<<<<<<<<<<<<<<<<<<<<<<<<<<▀▌▌▄!▌☺<<<<<<
// <<<<<<<▄▌▌▌▌J!<<<<<<<<<<<<<<<<<<☻▌▌<▌▌▌<<<<<<<<<<<<<<<<<<<<<<<<<<<!J▄▌▌▌▌<<<<<<<
// <<<<<<▌▌▌▌▌☻nnn<<<<<<<<<<<<<<<<<▀▌▌▀▀▌▌▌▄<<!▄▌▄!<<<<<<<<<<<<<<<<<<<nn▌▌▌▌▌<<<<<<
// <<<<<▄▌▌▌▌▀<<<<<<<<<<<<<<<<<<<<<J▌▌<▀▌▌▀▌▌J▌▌▀▀▀<<<<<<<<<<<<<<<<<<<<<!▌▌▌▌▌<<<<<
// <<!▄▄▌▌▌▌▀<<<<<<<<!▄▄<▄▌▌c<<<<<<J▌▌!▀▌▌@▌▌J▌▌▄<<<<<<<<<<<<<<<<<<<<<<<<!▌▌▌▌▄▄c<<
// !n<<<@▌▌▀▀▄<<<<<<<▀▌▌▀@▌▌▌<<<<J<<▀▀<▀▀<<▀▀<<▀▀<<<<<c<<<<!!!c<<<!JJJc<y▌▀▀▌▌<<n!!
// <<<<<▌▌<<<<l<<<<▌▌▌▄▄<@▌▌▌<!▌▌▌▌▄!y▌▌▄<▄▌▌<▄▌▌><!▌▌▌▌▄<▀▌▌▌▌▌y▌▀▀▀▀<l<<<<▀▌<<<<<
// <<<<<▌▌<<<<<<<<<▌▌▌▀<<@▌▌▌@▌▌▄▀▌▌▌J▌▌▌<▌▌▌<▀▌▌>▌▌▌!▀▌▀▀@▌▌▄<▀▌▌▄▄▌▌▄<<<<<@▌<<<<<
// <<<<<▌><<<<<<<<<▌▌▌<<<@▌▌▌@▌▌▄!▌▌▌J▌▌▌!▌▌▌J▀▌▌>▌▌▌▌<<<<@▌▌▄<!▀▀▀!▌▌▌<<<<<<▌<<<<<
// <<<<<▌c<<<<<<<<<▌▌▌<<<@▌▌▌▀▀▌▌▌▀▀<<▀▌▌▌▌▀▌▌▌▀▀<!▀▌▌▌<<<☻▌▌▌☺▄▌▌▌▄▀▀<<<<<<<▌><<<<
// <<<<<▌▌<<<<<<<<▄▌!<<<<<!▀<<<<▀<!<<<<<▀<<<!n<<<<<<!n<<<<<<▀<!▌▌▌▌▄<<<<<<<<!▌><<<<
// <<<<<▀▌<<<<<<<▀▀▌▀!▄▌▌▌▌▌▄<a▌▌▌▌▌▄<a▌▌▌▄<▄▌▌▌c<!▄▌▌▄!<!▄▌▌▄▀▌▌▌▀<<<<<<<<<@▌<<<<<
// <<<<<▀▌c<▄☻n<<<<<<<▀▌▌▌▀▌▌▌<▌▌▌▀n!▌▌▌▀▌▌▌<▌▌▌<▌▌▌▀▌▌▌▌▌▌▀▌▀<▌▌▌<<<<<<☻▄!!▌▌<<<<<
// <l▀☻▌▄▌▌▌▄<<<<<<<<<@▌▌▄!▌▀l<▌▌▌<<J▌▌▌<▌▌▌<▌▌▌<▌▌▌☺n<<▌▌▌<<<<▌▌▌<<<<<<<!▀▌▌▌▄☻▀☺<
// <<<<<▌▌▌▌▌<<<<<<<<<@▌▌▀n<<<<▌▌▌▄<<▀▌▌▌▌▀▀<▌▌▌<▀▌▌▌▌><▀▌▌▌▄!<▌▌▌▄c<<<<<▌▌▌▌▌<<<<<
// <<<<<!▀▌▌▌▌<<<<<<<<@▌▌▄<<<<<<▀▀<<<<!▀▀<<<!▌▀<<<<▀▀<<<<<▀▀<<<<▀▀<<<<<!▌▌▌▌▌l<<<<<
// <<<<<<<▌▌▌▌▌▀▀☺!<<<@▌▌☺<<<<<<<<<<<<<<<<<▀▌▌▌<<<<<<<<<<<<<<<<<<<<!l▀▀▀▌▌▌▀☺<<<<<<
// <<<<<<<▌▀▀▌▌▄<<<<<<!<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<y▌▌▌▀▌<<<<<<<
// <<<<<<#▀<<▀▌▌▌J<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<!▌▌▌▀<<!▌<<<<<<
// <<<<<<<<<<<<▀▌▀▌J<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<!▌▀▌▀<<<<<<<<<<<<
// <<<<<<<<<<<<<!▀▌▌▌▄<<<<<▄<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<@<<<<<▄▌▀▌▀n<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<▀▌▌▀▌▄<!▌<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<@▄<▄▌▀▌▌▀n<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<!▀▌▌▀▀▌▌▄c!<<<▄▀<<<<<<<<<<<<!▄<<<<!▄▌▄▌▀▌▌▀▀<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<<<!▄▌▀▌▌▌▌▌▌▄▌n<<<<<<<<<<<<<<<▀▌▌▌▌▌▌▌▌▌▌!<<<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<<▀▀<<<▀▀▀▌▌▌▌▌▌▌▌▌▄▄▄▄▄▄▄▌▌▌▌▌▌▌▌▌▌▌▀▀n<<▀▀<<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<<<<<<<<<<<<!▌<<<<<nnn<<<<n<<<<<▌▀<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
// <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<▀▄<<<<<<<<<<<<<<<<!▀<<<<<<<<<<<<<<<<<<nicedayJules

// SPDX-License-Identifier: MIT

pragma solidity ^0.8.4;

import '@openzeppelin/contracts/token/ERC721/ERC721.sol';
import '@openzeppelin/contracts/access/Ownable.sol';
import '@openzeppelin/contracts/security/ReentrancyGuard.sol';
import "@openzeppelin/contracts/utils/math/SafeMath.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol";
import "erc721a/contracts/ERC721A.sol";

import "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";

contract TheFlowersProject is ERC721A, Ownable, ReentrancyGuard {
    using SafeMath for uint256;
    using Strings for uint256;

    bool public paused = true;
    bool public revealed = false;

    uint256 public maxSupply = 50; 

    string private _baseURIextended1; // Negative % Image
    string private _baseURIextended2; // General Image
    
    string public notRevealedUri = "";

    AggregatorV3Interface internal priceFeed;

    mapping(address => bool) public isWhiteListed;

    mapping(address => uint256) public preSaleCounter;
    mapping(address => uint256) public publicSaleCounter;

    string _name = "The Flowers Project";
    string _symbol = "The Flowers Project";

    constructor() ERC721A(_name, _symbol) ReentrancyGuard() {
        priceFeed = AggregatorV3Interface(0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419); // mainnet
    }

    function _startTokenId() internal view virtual override returns (uint256) {
        return 1;
    }

    function ownerMint(uint256 _amount) external onlyOwner {
        mint(_amount);
    }

    function mint(uint256 amount) internal {
        require(!paused, "Dynamic-NFT Minting is Paused");
        require(totalSupply().add(amount) <= maxSupply, "Dynamic-NFT Maximum Supply Reached");
        _safeMint(msg.sender, amount);
    }

    function _baseURI() internal view virtual override returns (string memory){
        if(checkDeviation())
        {
            return _baseURIextended1;
        }
        else{
            return _baseURIextended2;
        }
    }

    function setBaseURI(string calldata baseURI1_, string calldata baseURI2_) external onlyOwner {
        _baseURIextended1 = baseURI1_;
        _baseURIextended2 = baseURI2_;
    }

    function togglePauseState() external onlyOwner {
        paused = !paused;
    }

    function airDrop(address[] memory _address, uint256[] memory _quantity) external onlyOwner {
        require(_address.length == _quantity.length, "Length not equal");
        require(totalSupply().add(_address.length) <= maxSupply, "Dynamic-NFT Maximum Supply Reached");
        for(uint i=0; i < _address.length; i++){
            _safeMint(_address[i], _quantity[i]);
        }
    }

    function reveal() external onlyOwner {
        revealed = true;
    }

    function withdrawTotal() external onlyOwner nonReentrant {
        uint balance = address(this).balance;
        payable(msg.sender).transfer(balance);
    }

    function setNotRevealedURI(string memory _notRevealedUri) external onlyOwner {
        notRevealedUri = _notRevealedUri;
    }
    
    function tokenURI(uint256 _tokenId) public view virtual override returns (string memory) {
        require(_exists(_tokenId), "Dynamic-NFT URI For Token Non-existent");
        if(!revealed){
            return notRevealedUri;
        }
        string memory currentBaseURI = _baseURI(); 
        return bytes(currentBaseURI).length > 0 ? 
        string(abi.encodePacked(currentBaseURI,_tokenId.toString(),".json")) : "";
    }

    function checkDeviation() internal view returns(bool) {
        uint80 roundId;
        int price;
        int priceOld;
        uint timeStamp;

        (roundId, price,, timeStamp,) = priceFeed.latestRoundData();

        uint timeStampOld = timeStamp;
        timeStamp -= 86400; // 1 day = 86400

        while (timeStampOld > timeStamp) {
            roundId -= 1;
            (,priceOld,, timeStampOld,) = priceFeed.getRoundData(roundId);
        }

        if(priceOld > price) {
            return true;
        }
        return false;
    }
}