// SPDX-License-Identifier: UNLICENSED

// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMXkolccdXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNkoOWMMMMMMMMMMMMMMMMMMMXxl::::o0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNl. ,0MMMMMMMMMMMMMMMMMWO;.dNWWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMWXOxkOKNWMMNo.  ;0WMMMMMMMMMWWMMMMNl..:KMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMNOd0W0l,.....,cxKW0,   ;OWMMMMMW0ocxNMMMWx'..lXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMNo..,c'.,odc,.   .cxl.  .,kNMMMMO,..'kMMMMNo...lXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMWx'......:ONNOo,.  ...   .'dNMMMK;...cXMMMMXl...lKMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMNKOc.......'ckXWNk:....   ...lKMMWd...'kWMMMMXo...cKMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMXx:'''....cc'...;lkKKx,.........:0WMK:...cXMMMMMNd...lXMMMMMMMMMMMMMMMMWWMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMWO;,:'......cK0d:'...';;'.::.......,kWWx,..,OMMMMMMNo...dWMMMMMMWNWMMMMW0kXMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMM0, :KO;.....'xWMN0xoc'.,lOO:. ..;,..'dNKx;..oNMMMMMMXc..:XMMMMXx::dXMMXo:OWMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMk'.;KWO;.. ..:KMMMMNk;;OWWd.   .cx:...l0Xo..;0MMMMMMMk'.lNMMWk,....lXNo,xWMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMO' ,OMWx'.  ..xWMMM0,.,0MMk.   .,kKl...:dl'..xWMMMMMMOcoKMMM0,.ll...ll,dWMMMMMWX0kkk0XWMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMK;..xWMXc.. ..cXMMM0, 'OMM0,   ..cXNd'.......cXMMNO0WNNWWNWWd.,0Xl....cXMMMWKxc,.....,oXMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMXc..oWMWk'. ..'OMMMK;..xWMX:   ..'kMNk,.... .,ONk;.,OMNOcoXX:.:XM0;  'OMMWXOxxkOOkd:..'kMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMWo..cXMMK:,;. .dWMMX:..oNMWo.  ...cXMWO:...  .ll. ..lNO,.;K0,.lNMNl  cNWK0XNMMMMMMMK:.:KMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMx..,0MMWOl'  .cOdxKo..:KMMx.  .  .cOXW0x:.   ......;K0,.,0k..dWMWo. l0olKMMMMMMMMMK;'kWMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMM0,..dWMNk;.   ....oo..'OMMO.  ..  ..;ok0k;.    'c'.'kK;.'kd..xMMWo..o:.xWMMMMMMMMNo'xWMMMMMMMMMMMMMMM
// MMMMMMMWXNMMNO0WXc..:0K0Ko.   .....'...dWMO'  .'. ......,'.    :k:..oKc..ol.'OMMNo:xl..xMMMMMMMMWx,dNMMMMMMMMMMMMMMMM
// MMMMMWKl,xWKc.cNWk'..cKWNl.   'oc...  .lNM0,  .,...coc,'..,.   cKo..cKl..:; ;KMMWNNXc..lXMMMMMMWx;dNMMMMMMMMMMMMMMMMM
// MMMMMNo..lNx..cNMXl..,kWX: .. ,0Xo'..  ,0M0'  .,'..lNWXK0KXl.  lNk..;Od.... cXMMMMMWd..'kWMMMMWx;dNMWMMWXNMMMMMMMMMMM
// MMMMMWd..cXk';OWMM0;..;0O'.,' ;KMWk;.  .dWk.  .',..;KMMMMMWx.  lN0,.'kx. . .oWMMMMMM0;..;OWMMWk;dNNkxXKo:OMMMMMMMMMMM
// MMMMMMk,:OWX0XMMMMWx'..;:.'o, :XMMMKl.  ,dl,;...'...kWMMMMMk.  lNK:..xk,   .xMMMMMMMWk,..:0MWk;dNXl.lXl.:XMMMMMMMMMMM
// MMMMMMNKNMMMMMMMMMMNd'.. .lk,.lNMMWXd;...,dKK:..'...lNMMMMMO'  lNNl..o0;   'OMMMMMMMMNd'..c0k;dNMk''O0;,OWMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMNd'.'oXk..dWWX0O0KOxxKWMWd......:KMMMMMK,  lNWo..c0l.  ;KMMMMMMMMMNd...',dNMWko0WKOXMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMNOkKWWd..okddOKXNWWMMMMM0;.....,OMMMMMK;  cNWx..;0d.  cXMMMMMMMMMMNo.. ,0MMMWWMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMNl .......',;cldx0KKc.    .:odxk0O;.,kWMO'.'OKc..lNMMMMMMMMMMMXc  .oNMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMWO,'oxxddol:;'.....';'   .'.......'..:x0X0;..dWk..lNMMMMMMMMMMWk:'...dNMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMK:.,0MMMMMMWNX0kdl:'..  .:0KOkxdl;'.....,;. .oNx..lNMMMMMMMMMWklO0c..'kWMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMWNNNXXXXXNNNWWWO,..oNMMMMMMMMMMMMNKx,.  'lolllcc;'.....    .,l;..cXMMMMMMMMNkdKMM0;..:KMMMMMMMMMMMMMMMMMMMM
// MMMMMWKxoc;;,'''''',,;;;:;.  .cdxxkkOOOOOkxdolc;.        ..',,,'....       'OMMMMMMMNOONMMMWx'..xWMMMMMMMMMMMMMMMMMMM
// MMMW0dlccloooooooollcc::;,'.   ..........'';cdKKc. .'......,lk0XK0Okxoc:;...:0WMMMMWXNWMMMMMXc..lNMMMMMMMMMMMMMMMMMMM
// MMKl,cKWMMMMMMMMMMMMMMWWWNXx'...lkkkkkOO0KXWMMMWd..,k0xdl;....:d0NMMMMMWNd'..,ldxOXWMMMMMMMMWx..dWMMMMMMMMMMMMMMMMMMM
// MWd.'lKMMMMMMMMMMMMMMMMMMMMWx'..:0WMMMMMMMMMMMMM0,..xWMMWXOo;...'ckXWMMMMNk:,'':xKWMMMMMMMMMM0oONMMMMMMMMMMMMMMMMMMMM
// MMXk0NMMMMMMMMMMMMMMMMMMMMMMNx'..;0WMMMMMMMMMMMMXc..lNMMMMMMNOl,...;xXMMMMMWXKXWMMMMMMMMMMMMMMWMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMNx,..;kWMMMMMMMMMMMWd..:KMMMMMMMMWKd;...:kNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWk,..,xNMMMMMMMMMMMO'.'OMMMMMMMMMMWKd,...lKMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWO;..'oXMMMMMMMMMMK;..xWMMMMMMMMMMMWKl'..:0MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0c...c0WMMMMMMMMNl..lNMMMMMMMMMMMMMNx,.'xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMXo'..;kNMMMMMMMWd..cXMMMMMMMMMMMMMMWxlkNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNx,..'oXMMMMMMMk..:KMMMMMMMMMMMMMMMWWWXxxXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0:...:kNMMMMMO' :XMMMMMMMMMMMMMMMMM0:..dNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMXd,..'l0WMMMO,.lNMMMMMMMMMMMMMMMMMXc..,OMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0c...,lONWk';0MMMMMMMMMMMMMMMMMMM0;..lNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNk:....;cldKWMMMMMMMMMMMMMMMMMMMWd..,0MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOo:;:oKWMMMMMMMMMMMMMMMMMMMMMM0;..xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNWMMMMMMMMMMMMMMMMMMMMMMMMMNl.c0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMK0NMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
// ███╗   ███╗ █████╗ ██████╗ ███████╗   ██╗    ██╗██╗████████╗██╗  ██╗   ███╗   ███╗ █████╗ ███████╗ ██████╗ ███╗   ██╗
// ████╗ ████║██╔══██╗██╔══██╗██╔════╝   ██║    ██║██║╚══██╔══╝██║  ██║   ████╗ ████║██╔══██╗██╔════╝██╔═══██╗████╗  ██║
// ██╔████╔██║███████║██║  ██║█████╗     ██║ █╗ ██║██║   ██║   ███████║   ██╔████╔██║███████║███████╗██║   ██║██╔██╗ ██║
// ██║╚██╔╝██║██╔══██║██║  ██║██╔══╝     ██║███╗██║██║   ██║   ██╔══██║   ██║╚██╔╝██║██╔══██║╚════██║██║   ██║██║╚██╗██║
// ██║ ╚═╝ ██║██║  ██║██████╔╝███████╗   ╚███╔███╔╝██║   ██║   ██║  ██║   ██║ ╚═╝ ██║██║  ██║███████║╚██████╔╝██║ ╚████║
// ╚═╝     ╚═╝╚═╝  ╚═╝╚═════╝ ╚══════╝    ╚══╝╚══╝ ╚═╝   ╚═╝   ╚═╝  ╚═╝   ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═╝  ╚═══╝

pragma solidity ^0.8.13;

import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/finance/PaymentSplitter.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Address.sol";
import "@openzeppelin/contracts/utils/Counters.sol";
import "./EIP712Common.sol";
import "erc721a/contracts/ERC721A.sol";

contract Glyphic is ERC721A, ReentrancyGuard, Ownable, EIP712Common{
  using Counters for Counters.Counter;

  uint256 public PRICE;
  uint256 public WHITELIST_PRICE;
  uint256 public MAX_SUPPLY;
  uint256 public MAX_RESERVED_SUPPLY;
  uint256 public MAX_PUBLIC_SUPPLY;
  uint256 public MAX_PER_WALLET;
  uint256 public MAX_MULTIMINT;
  uint256 public MAX_WHITELIST_MULTIMINT;

  Counters.Counter private reservedSupplyCounter;

  PaymentSplitter private _splitter;

  constructor (
    string memory tokenName,
    string memory tokenSymbol,
    string memory customBaseURI_,
    address[] memory payees,
    uint256[] memory shares,
    uint256 _tokenPrice,
    uint256 _tokensForSale,
    uint256 _tokensReserved
  ) ERC721A(tokenName, tokenSymbol) {
    customBaseURI = customBaseURI_;

    PRICE = _tokenPrice;
    WHITELIST_PRICE = _tokenPrice;

    MAX_SUPPLY = _tokensForSale;
    MAX_RESERVED_SUPPLY = _tokensReserved;
    MAX_PUBLIC_SUPPLY = MAX_SUPPLY - MAX_RESERVED_SUPPLY;

    MAX_PER_WALLET = 10;

    MAX_MULTIMINT = 10;
    MAX_WHITELIST_MULTIMINT = 10;

    _splitter = new PaymentSplitter(payees, shares);
  }


  /** MINTING **/

  function mint(uint256 count) public payable nonReentrant {
    require(saleIsActive, "Sale not active");
    require(msg.sender == tx.origin, "Contracts cannot mint");
    require(totalSupply() - totalReservedSupply() + count - 1 < MAX_PUBLIC_SUPPLY, "Exceeds max supply");
    require(count - 1 < MAX_MULTIMINT, "Trying to mint too many at a time");
    require(
      msg.value >= PRICE * count, "Insufficient payment"
    );

    if (allowedMintCount(msg.sender) > count) {
      updateMintCount(msg.sender, count);
    } else {
      revert("Minting limit exceeded");
    }

    _safeMint(msg.sender, count);

    payable(_splitter).transfer(msg.value);
  }

  function ownerMint(uint256 count, address recipient) external onlyOwner() {
    require(totalReservedSupply() + count - 1 < MAX_RESERVED_SUPPLY, "Exceeds max reserved supply");
    require(totalSupply() + count - 1 < MAX_SUPPLY , "Exceeds max supply");

    for (uint256 i = 0; i < count;) {
      reservedSupplyCounter.increment();
      unchecked { ++i; }
    }

    _safeMint(recipient, count);
  }

    function whitelistMint(uint256 count, bytes calldata signature) public payable requiresWhitelist(signature) nonReentrant {
    require(whitelistIsActive, "Whitelist not active");
    require(totalSupply() - totalReservedSupply()  + count - 1 < MAX_PUBLIC_SUPPLY, "Exceeds max supply");
    require(count - 1 < MAX_WHITELIST_MULTIMINT, "Trying to mint too many at a time");
    require(
      msg.value >= WHITELIST_PRICE * count, "Insufficient payment"
    );

    if (allowedMintCount(msg.sender) > count) {
      updateMintCount(msg.sender, count);
    } else {
      revert("Minting limit exceeded");
    }

    _safeMint(msg.sender, count);

    payable(_splitter).transfer(msg.value);
  }

  function totalReservedSupply() public view returns (uint256) {
    return reservedSupplyCounter.current();
  }

  /** ACTIVATION **/

  bool public saleIsActive = false;
  bool public whitelistIsActive = true;

  function flipSaleState() external onlyOwner {
    saleIsActive = !saleIsActive;
  }

  function flipWhitelistState() external onlyOwner {
    whitelistIsActive = !whitelistIsActive;
  }

  /** ADMIN **/

  function setPrice(uint256 _tokenPrice) external onlyOwner {
    PRICE = _tokenPrice;
  }

  function setWhitelistPrice(uint256 _tokenPrice) external onlyOwner {
    WHITELIST_PRICE = _tokenPrice;
  }

  function setMultiMint(uint256 _maxMultimint) external onlyOwner {
    MAX_MULTIMINT = _maxMultimint;
  }

  function setWhitelistMultiMint(uint256 _maxMultimint) external onlyOwner {
    MAX_WHITELIST_MULTIMINT = _maxMultimint;
  }

  function setMaxPerWallet(uint256 _maxPerWallet) external onlyOwner {
    MAX_PER_WALLET = _maxPerWallet;
  }

  /** MINTING LIMITS **/

  mapping(address => uint256) private mintCountMap;

  function allowedMintCount(address minter) public view returns (uint256) {
    return MAX_PER_WALLET - mintCountMap[minter];
  }

  function updateMintCount(address minter, uint256 count) private {
    mintCountMap[minter] += count;
  }

  /** Whitelist **/

  function checkWhitelist(bytes calldata signature) public view requiresWhitelist(signature) returns (bool) {
    return true;
  }

  /** URI HANDLING **/

  string private customBaseURI;

  function baseTokenURI() public view returns (string memory) {
    return customBaseURI;
  }

  function setBaseURI(string memory customBaseURI_) external onlyOwner {
    customBaseURI = customBaseURI_;
  }

  function _baseURI() internal view virtual override returns (string memory) {
    return customBaseURI;
  }

  /** PAYOUT **/

  function release(address payable account) public virtual onlyOwner {
    _splitter.release(account);
  }
}