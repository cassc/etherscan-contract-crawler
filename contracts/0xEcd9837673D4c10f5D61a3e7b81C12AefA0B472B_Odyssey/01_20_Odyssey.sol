/**   -------------------------------*+----------------------------------=#-------------------------------
      [email protected]=---------------------------------%+-------------------------------
      --------------------------------#%--------------------------------*%--------------------------------
      [email protected]*[email protected]+--------------------------------
      ---------------------------------*@------------------------------%%---------------------------------
      [email protected]#----------------------------*@=---------------------------------
      ----------------------------------*@[email protected]%----------------------------------
      [email protected]@--------------------------#@=----------------------------------
      -----------------------------------*@#[email protected]#-----------------------------------
      [email protected]@[email protected]@+-----------------------------------
      +##+--------------------------------#@@----------------------%@@--------------------------------=*#*
      ---*%%*[email protected]@#[email protected]@+-----------------------------+#%*=--
      -----=*@%*=--------------------------#@@[email protected]@@--------------------------=*%@#=-----
      --------=#@@#[email protected]@@--------+*--------#@@+-----------------------=*@@#+--------
      -----------+#@@%*=--------------------*@@#-------*#-------*@@%---------------------+#@@#+-----------
      --------------+#@@@#[email protected]@@#------%@[email protected]@@=-----------------=*%@@%+--------------
      -----------------+#@@@#[email protected]@@#=---*@@#----*@@@#-+---=+--------=#@@@%*-----------------
      --------------------+%@@@%*=-----=#=--**@@@@@@@@@@@@@@@@@@@@**--=#+-----=+#@@@%*--------------------
      -----------------------+%@@@@#+----#%[email protected]@@@@@@@@@@@@@@@@@@@*=+#%----=*%@@@%*=----------------------
      --------------------------*%@@@@@#=-#@@@@@@@@@@@@@@@@@@@@@@@@@@%-=*%@@@@@*=-------------------------
      ----------------------------=*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=----------------------------
      -----------------=+*#**++==----=*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#+-----==++*#**+-----------------
      ---------------------=+#%@@@@@%%##%@@@@@@@@*++%@@@@@@%++#@@@@@@@@@##%%@@@@@%#*=---------------------
      ---------------------------+*#@@@@@@@@@@%+--=#+*@@@@*+#=--+%@@@@@@@@@@%*+=--------------------------
      -------------------------------=#%@@@@@@++#@@=-*@@@@[email protected]@#[email protected]@@@@@%%+-------------------------------
      --------------------------------+%@@@@@@@+#@%=*@@@@@@*=%@#[email protected]@@@@@@@+--------------------------------
      ----------------------------------#@@@@@*[email protected]@@##@@@@##@@@=-*@@@@@%=---------------------------------
      -----------------------------------%@@@@[email protected]@+-#@@@@#-*@@[email protected]@@@@-----------------------------------
      [email protected]@@@@[email protected]%-#@@@@@@*-%@[email protected]@@@@+----------------------------------
      ----------------------------------%@##@%[email protected]@@*@%==%%*@@@[email protected]@##@@=---------------------------------
      [email protected]@@--*@[email protected]%-##----##-%@[email protected]*[email protected]@@*--------------------------------
      [email protected]@@%*+------------------+%@@@%--%@[email protected]+%#------##[email protected][email protected]%--%@@@@*------------------=*%@@@#-----
      -----=%@@@@@@%#*=----------=#@@@[email protected]@@@@@@-*@@%--------%@@*[email protected]@@@@@@[email protected]@@#+----------=+#%@@@@@@@*-----
      --------+#@@@@@@@@@%%####%@@@@@%*@@@@@@@@%%@@[email protected]@%%@@@@@@@@*%@@@@@%#####%@@@@@@@@@%*=-------
      -----------=*%@@@@@@@@@@@@@@@%*#@@@@@@@@#[email protected]@%----------%@@**@@@@@@@@#*%@@@@@@@@@@@@@@@@#+-----------
      ---------------+#@@@@@@@@@@@@---%@@@@@@=--*@%----------%@%---%@@@@@%[email protected]@@@@@@@@@@@%*=--------------
      ------------------=*%@@@@@@@@%[email protected]@@@@%[email protected]@[email protected]@=---*@@@@@--=%@@@@@@@@@#+------------------
      ----------------------*%@@@@+#@@#*@@@@@----*@#--------#@%----%@@@@*#@@#[email protected]@@@@*=---------------------
      ------------------------+%@@*[email protected]@%+%@@@%[email protected]@*------#@@+---#@@@%+%@@=-*@@@*------------------------
      [email protected]@@%%@#--#@@@@[email protected]@@%+--+%@@@*--%@@@#--#@#%@@@*--------------------------
      ----------------------------#@@@@@@*-%@@@@-#@@@@@%%@@@@@@-#@@@%-*@@@@@@%=---------------------------
      -----------------------------*@@@@@@@%@@@@#@#@@@@@@@@@@#@#@@@@%@@@@@@@#-----------------------------
      [email protected]@@@@+-*@@@@=*@@@#@@#@@@*[email protected]@@@*[email protected]@@@@+------------------------------
      [email protected]@@@@[email protected]@%[email protected]@@[email protected]@[email protected]@@=-%@@[email protected]@@@@+-------------------------------
      [email protected]@%@@%@*[email protected]@@[email protected]@[email protected]@@+-*@%@@%@@+--------------------------------
      ---------------------------------*@+-%@==#@@%[email protected]@----%@@#[email protected]%[email protected]%---------------------------------
      [email protected]+*@%@@%@#[email protected]@-----#@%@@%@**@=---------------------------------
      ----------------------------------%@@@%+*@#[email protected]@------#@*+%@@@@----------------------------------
      [email protected]@%+-#@#[email protected]@-------#@#-+%@@=---------------------------------
      ---------------------------------#@+-=%@#[email protected]@--------#@%[email protected]%---------------------------------
      --------------------------------##--*@@#[email protected]@---------#@@*--#@--------------------------------
      -------------------------------#*[email protected]@@%[email protected]@----------%@@%+-*%-------------------------------
      ------------------------------*@#@%@@@[email protected]@[email protected]@@%%#@%------------------------------
      [email protected]%[email protected]@[email protected]@[email protected]@=-+%@*-----------------------------
      -----------------------------%#---*@*[email protected]@=-----------*@*---#@-----------------------------
      [email protected]%@[email protected]@[email protected]%[email protected]*----------------------------
      ----------------------------*#[email protected]*[email protected]@+------------*@=---##----------------------------
      ----------------------------+#[email protected]@[email protected]@[email protected]@+--##----------------------------
      [email protected]=#@@@-------------*@@[email protected]@@*[email protected]+----------------------------
      -----------------------------%@#[email protected]@-------------*@@*[email protected]@+#@@-----------------------------
      [email protected]#@-------------#@@#[email protected]#[email protected]#-----------------------------
      ------------------------------%=-*@+------------#@@#[email protected]*[email protected]=-----------------------------
      ------------------------------+%-*@@------------%@@%[email protected]@*-%#------------------------------
      -------------------------------%@@#@%[email protected]@@@-----------%@#@@@-------------------------------
      [email protected]@[email protected]%[email protected]@@@=---------%@[email protected]@=-------------------------------
      [email protected]*[email protected]%[email protected]@@@+--------%@+-*@+--------------------------------
      ----------------------------------%*[email protected]@@+------#@@@@#[email protected]@@+*%=---------------------------------
      [email protected]@@@@%[email protected]@@@@@----=%@@@@@*-----------------------------------
      -------------------------------------===*@@%**%@@@@@@%**%@@#===-------------------------------------
      -----------------------------------------=%%####%@@%####%%*----------------------------------------- */

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import "@openzeppelin/contracts/utils/cryptography/MerkleProof.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/Counters.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Strings.sol"; 
import {DefaultOperatorFilterer} from "./DefaultOperatorFilterer.sol";

contract Odyssey is ERC721, ERC721URIStorage, Ownable, DefaultOperatorFilterer, ReentrancyGuard {

    string _baseTokenURI;
    
    bytes32 private _merkleRoot;
    mapping(address => bool) public claimed;        
    
    string public uriSuffix = ".json"; 
    
    
    uint256 private MAX_SUPPLY = 6000; 
    uint256 public totalTokensMinted = 0;
    bool public _alienCoefficient = false;
    
    using Counters for Counters.Counter;
    Counters.Counter private _tokenIds;
    
    bool public mintingAllowed = false;
    bool public allowlistMintingAllowed = false;

    modifier mintCompliance() {
        require(totalTokensMinted < MAX_SUPPLY, "Sold out"); 
        require(!claimed[msg.sender],"You are only allowed to mint once");        
        require(msg.value >= 0, "Invalid value");                                                                      
        _;
    }

    constructor() ERC721("ODYSSEY", "ODSY") {                            
    }

    function _baseURI() internal view virtual override returns (string memory) {
        return _baseTokenURI;
    }

    function setBaseURI(string memory baseURI) public onlyOwner {
        _baseTokenURI = baseURI;
    }
    
    function setMerkleroot(bytes32 merkleRoot) public onlyOwner {
        _merkleRoot = merkleRoot;
    }

    function enableMinting() public onlyOwner {
        mintingAllowed = true;
    }
    
    function disableMinting() public onlyOwner {
        mintingAllowed = false;
    }

     function enableAllowlistMinting() public onlyOwner {
        allowlistMintingAllowed = true;
    }
    
    function disableAllowlistMinting() public onlyOwner {
        allowlistMintingAllowed = false;
    }

    function setAlienCoefficient(bool alienCoefficient) public onlyOwner {
        _alienCoefficient = alienCoefficient;
    }

    function getAlienCoefficient() public view returns (bool) {
        return _alienCoefficient;
    }

    function towerMint() public payable mintCompliance(){        
        require(mintingAllowed,"Minting not allowed");                   
        _mint();
    }

    function towerPreMint(bytes32[] calldata merkleProof) public payable mintCompliance() {
        require(allowlistMintingAllowed,"Preminting not allowed");           
        bytes32 leaf = keccak256(abi.encodePacked(_msgSender()));   
        require(MerkleProof.verify(merkleProof, _merkleRoot, leaf) == true, "Invalid merkle proof");                                 
        _mint();
    }
    
    function _mint() internal {
        uint256 tokenId = _tokenIds.current();
        _safeMint(msg.sender, tokenId);                
        claimed[msg.sender] = true;
        totalTokensMinted++; 
        _tokenIds.increment();           
    }

    function makeTower(address lord) public payable onlyOwner {
        require(totalTokensMinted < MAX_SUPPLY, "Sold out");            
        require(msg.value >= 0, "Invalid value");  
        uint256 tokenId = _tokenIds.current();
        _safeMint(lord, tokenId); 
        claimed[lord] = true;  
        totalTokensMinted++; 
        _tokenIds.increment();                                                                            	    
    }
    
    function _burn(uint256 byTokenId) internal override(ERC721, ERC721URIStorage) {
        super._burn(byTokenId);
    }
    
    function _startTokenId() internal view virtual returns (uint256) {
        return 0;
    }

    
    function walletOfOwner(address _owner) public view returns (uint256[] memory) {
        uint256 ownerTokenCount = balanceOf(_owner);
        uint256[] memory ownedTokenIds = new uint256[](ownerTokenCount);
        uint256 currentTokenId = _startTokenId();
        uint256 ownedTokenIndex = 0;
        address latestOwnerAddress;

        while (ownedTokenIndex < ownerTokenCount && currentTokenId <= MAX_SUPPLY) {
        if (_exists(currentTokenId)) {
            address ownership = ownerOf(currentTokenId);

            if (ownership != address(0)) {
                latestOwnerAddress = ownership;
            }

            if (latestOwnerAddress == _owner) {
            ownedTokenIds[ownedTokenIndex] = currentTokenId;

            ownedTokenIndex++;
            }
        }

        currentTokenId++;
        }

        return ownedTokenIds;
    }
   
    function tokenURI(uint256 byTokenId) public view virtual override(ERC721, ERC721URIStorage) returns (string memory) {
        require(_exists(byTokenId), "ERC721Metadata: URI query for nonexistent token");

        string memory currentBaseURI = _baseURI();
        return bytes(currentBaseURI).length > 0
            ? string(abi.encodePacked(currentBaseURI, Strings.toString(byTokenId), uriSuffix))
            : '';
    }

    function withdraw() public onlyOwner nonReentrant {    
        (bool success, ) = payable(owner()).call{value: address(this).balance}('');
        require(success);    
    }

    function transferFrom(address from, address to, uint256 tokenId) public override onlyAllowedOperator(from) {
        super.transferFrom(from, to, tokenId);
    }

    function safeTransferFrom(address from, address to, uint256 tokenId) public override onlyAllowedOperator(from) {
        super.safeTransferFrom(from, to, tokenId);
    }

    function safeTransferFrom(address from, address to, uint256 tokenId, bytes memory data)
        public
        override
        onlyAllowedOperator(from)
    {
        super.safeTransferFrom(from, to, tokenId, data);
    }
}