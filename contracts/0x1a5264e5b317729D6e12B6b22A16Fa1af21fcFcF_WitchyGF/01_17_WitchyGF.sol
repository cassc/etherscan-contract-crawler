// NiftyCastle
// ................................................................................................................................................................................
// ................................................................................................................................................................................
// ................................................................................................................................................................................
// ................................................................................................................................................................................
// ............................................................................::::^^^^^^^^^^^^^^^^::::............................................................................
// ................................................................:..::^~~~~~~~~^^^^^::::::::::^^^^^~~~~~~~~^^::..................................................................
// ..............................................................::P7~~^:::................................:::^~~~~~^^:............................................................
// .......................................................:^~!~^7JG#5BP~...........................................::^~~~~^:.......................................................
// ...................................................:~~!~^:..G&BP??^~:.................................................:^~!~^:...................................................
// ...............................................:^!!~::[email protected]&B#7~7!......................................................::~!!^:...............................................
// ............................................:~!~^:........:@@P!~~!~!~::..  ......:::::::......................................:^~!~:............................................
// .........................................:~!~:[email protected]@@?~77~:::::^^~!!77????????777!!!~!!~~~^^::...........................:~!~:.........................................
// ......................................:~!~:............... [email protected]@!~7^::^!7???7777777777777777777777???????7!~^:.........................:~!~:......................................
// ....................................^!!^...........!^. .....&&^::^!7?777777777777777777?7777?????77??7777!!~^^: ........................^!!^....................................
// .................................:~7~:[email protected]^7:~7777777777777777777777777???777777777777???77^YY: ........................:~7~:.................................
// ...............................:~7^...............:@@BB?:!~^:^77777777777777777777777777777777777777!!~~~!!77^[email protected]@B! .........................^7~:...............................
// .............................:!7^[email protected]@5~!~::!?77???7777777????????777777!!~~~~~~~~^^^^~!!!~~:[email protected]@@BB#&&P.^:....................^7!:.............................
// ............................~7^...........~?: [email protected]!^:.^[email protected]@&#@@@@@B:~~!~:...................^7~............................
// ..........................^7~...........J&&::. ..... ...:[email protected]@@@@@@@@@&~^~~^!7^...................~7^..........................
// ........................:[email protected]@B!BJ!! . ~~^~!7!!7???777???7~~7????????77777??77!!!!7?JYY555YJ!!?G&@&&@@@@BYY5Y~~77~!77^ ..................!7:........................
// .......................~7^........... 7#J&PYGG#?. ^????777???7!7??7?!^!???????777777?7!~!J5B&&@@@@@@@@@@@@&&BPY#&&@@J:~!777~!?777?! ..................^7~.......................
// .....................:7!............J: &&G5PP55!~~???777????!~7??77~~7???????777??7!~?G&@@@@@@@@@@@@@@@@@@@@@@&#B5?!::?77?77!7???7?~ ...................!7:.....................
// ....................:?^............ ~BY#&@#GY#5:~?77777???7^!???77^!?777???777??7~7P&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@7.?~:!???777?7?77?.....................^?:....................
// ...................~?:[email protected]@[email protected]?^!~77?????7^7???77^[email protected]@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#:7J?7:~??777????7?^ ....................:?~...................
// ..................~7............. [email protected]@P#5&&Y&&&5#5~~7?77?7^7??777^!?777??777??~7#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@!~?????^^???77???7?~ ......................7~..................
// .................!7............... 5G!5##[email protected]@5^~7??7~!??77!^^[email protected]@@@@@&@@@@@@&#G5J???JJ5G#&@@@@@@@B:7?!~:^!^^??7??????^ .......................7!.................
// ................!7.................!?B&B5BY5#[email protected]^!777!7?77!7^^7?777??77?!!#@@@@@&[email protected]@&G?!!!!!~!!!!!~~~J#@@@@@J~7?:77^^!^^?7??????..........................7!................
// ...............~?................... [email protected]@P##?&@B5&!~?????77~~7~!7?!!???77?!!&@@@@@@YB&JJ?~^~!!!7YG#&&&@&&&B#@@@@@~!??^7??~:?~:??????! .... .....................?~...............
// ..............^?:[email protected]@@5Y&@@@&?^!!!~~~~!777??~^[email protected]@@@@@@@#5&G..:~7YG&@&&@@@@@@@@@@@@@@&~7?7!^~~:~7J:~???7^: . . !:....................:?^..............
// .............:?:.......................5#&@#&@@@@!~:!!777????7!^[email protected]@@@@@@@@@&#BGPB&&[email protected]&#~7GGG7Y&&&&@@@@@@~7???7:^:!??!:!??!...:[email protected] ....................^?:.............
// .............7~.........................:^[email protected]@[email protected]@@#5#[email protected]@@@@@@@@@@@@@@@@#!~55GGBB#BGG5J^J#&@@@@B~~!77^:.~77:~~~?!:[email protected]#BG?Y! ...................~7.............
// ............^?........................... [email protected]@@@@J^~~~!!!7?????7~^Y&@@@@@@@@@@@@@@@&Y?P#@@@&#GGPGB&@@@B7!&@@@@!.::^^^^^^:~??~.::[email protected]?.....................?^............
// ............?^.......................... [email protected]@&:^~#@@@@JYP?~!!!!77!^ :&@@@@@@@@@@@@@@@@[email protected]@@#J^...   ..:7#@@G:[email protected]@@^7?77?~??:7?!^~5#@@@@@#!.PBY:....................^?............
// ...........~?........................... #@&&!?.^5B&@@@@@&BGPYJ~:.. !&@@@@@@@@@@@@@@G^&@@&7. ..........  [email protected]@#:#@@:7?777:??:!^[email protected]@&BP55&@@^ ........................7~...........
// ...........?^........................... #BJP^:~!G:PPPPPG?!~:....... [email protected]@@@@@@@@@@@@&:[email protected]@@7 .............. [email protected]@[email protected]@^!??77:??^[email protected]@&JJG&@[email protected]@5 ........................^?...........
// ..........:?............................ ?&[email protected]&~^:[email protected]@@@@&. .......... [email protected]@@@@@@@@@@@#:@@@@:............... [email protected]@[email protected]@?^?777:7~:[email protected]@[email protected]@@@[email protected]@5 .........................?:..........
// ..........!!..............................&@@@@[email protected]@@@@@: .......... ^@@@@@@@@@@@@#:@@@@7 .............. [email protected]@G:@@#.7?7?^:^#@&[email protected]@@@@@B&@@~ .........................!!..........
// ..........?^............................. [email protected]@@@@P .#@@@@@G  ......... :@@@@@@@@@@@@@[email protected]@@&: ............ [email protected]@@^[email protected]@@5:?77!.#@&[email protected]@@@@@@@@@# ..........................^?..........
// ..........J:.............................. [email protected]@@@@B:[email protected]@@@@@#!.. ...... [email protected]@@@@@@@@@@@@#^[email protected]@@&J:.. ...  [email protected]@&[email protected]@@@@J:77:[email protected]&[email protected]@@@@@@@@@@~ ..........................:J..........
// .........:J:............................... [email protected]@&YP!^&@@@@@@@&GY7!!7?::&@&@@@@@@@@@@@@&!Y&@@@@#G5J??J5B&@@@&G#@@@@@@@[email protected]@#!PG&@@@@@@@@7 ...........................:J:.........
// .........:?................................. [email protected]#[email protected]@P!&&&@@@@@@@@@&P7Y&@&^B####&@@@@@@@@PJ5B&@@@@@@@@@@@@B#@@@@@@@@@@@@@@@@@&&G!#@@@@@B: .............................?:.........
// .........^?.................................. ^[email protected]@@@B~#GJPYPGPPYJJP&@@@@BPGGGB&@@@@@@@@@@&[email protected]&#@@@@@@@@@@@@&[email protected]@@@@@[email protected]@@#! ...............................?^.........
// .........:?.....................................~5#&@[email protected]@P##G#&@@@@@@@@@&&&&&@@@@@@@@@@@@@@@@&&&&&#@@@@@@@@@@@@@@@@@P..&@@@@@@@&P~..................................?:.........
// .........:J:.......................................::.. ~#@@@@@@@@@@@@#Y7!!!!!75#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@B^ ..:5#&&B5!. ..................................:J:.........
// ..........J:..............................................?&@@@@@@@&G5..~77!!!!: ~GG&@@@@@@@@@@@@@@@@@@@@@@@@@@@&P^ ................................................:J..........
// ..........?^.............................................. .7#@@@@@@@@&5?7777777JB&&@@@@@@@@@@@@@@@@@@@@@@@@@@#J: ..................................................^?..........
// ..........!!................................................ .^5&@@@@@@@@&&###&@@@@@@@@@@@@@@@@@@@@@@@@@@@@&5^. ....................................................!!..........
// ..........:?................................................... .~Y#&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#5~. .......................................................?:..........
// ...........?^.......................................................:^75B&&@@@@@@@@@@@@@@@@@@@@@@&#B5?^.  .........................................................^?...........
// ...........~?..........................................................^. :^~!?JY5PGGGGPPPYJ?7~:.       ...........................................................7~...........
// ............?^......................................................:!777: .........                   ...........................................................^?............
// ............^?......................................................^!^~!~..........                  ............................................................?^............
// .............7~................................................... ?J~7Y5!. ....... !G!.            .............................................................~7.............
// .............:?^................................................~?!~:!PBB7 .........&@@@&BG5555P#5..............................................................^?:.............
// ..............^?:.............................................~75&BP~:7Y7:........ [email protected]@&@@@@@@@@@G..............................................................:?^..............
// ...............~?........................................... ^J~J&&##&!  ........ [email protected]@@[email protected]@@@@@@@5 ..............................................................?~...............
// ................!7..........................................^77^P~!^^~::^^^...   [email protected]@@@5&@@@@@@J ..............................................................7!................
// .................!7........................................^~?~~Y?77.7BG777.!.:[email protected]@@@@P#@@@@&J!^.............................................................7!.................
// ..................~7..................................... .^!?.!G!~7.!~  ~.J&[email protected]@@@@@@[email protected]@@@[email protected]~...........................................................7~..................
// ...................~?:................................. :^^!7^:.. :: ...~~.~PB [email protected]@@@@@&&@@@@&@@@J:^ ......................................................:?~...................
// ....................:?^................................^!~^:.:7!..!!^.:!^~. [email protected]@@@@@@@@@@@@@@^^5  ....................................................^?^....................
// .....................:7!................................... .!!..!!~:. ~7:. ~!PG:J&@@@@@@@@@@@&J:5:^. ..................................................!7:.....................
// .......................~7^.................................. :.^?J?7...:J7!~^#PBP:7YP#&@@@&&BY!.P?.J?: ...............................................^7~.......................
// ........................:7!................................. .!J??????J:~!!7:5###P!GPYY5YYJJJ5?7##^~7^^..............................................!7:........................
// ..........................^7~................................?J???????J!^JJJ!~####P~GGYYYYYYY!~###?^J!^7...........................................~7^..........................
// ............................~7^.............................?J?????????J~77!!.G####G!5#BGPPGY7B###5.7!:J7........................................^7~............................
// .............................:!7^..........................?J??????7????77??J~7#####B?JB#&#J?#####G.77:?J! ....................................^7!:.............................
// ...............................:~7^..................... .7J??????J~7????????!:#######P?JJ?P######B:7J^!?J! .................................^7~:...............................
// .................................:~!~:...................?J?????7!J^7????77!!7.P#######G. Y&#######^~!:!J?J~ .............................:~!~:.................................
// ....................................^!!^.............. .?J???????^?:7????~?JJJ^?######B7^.~P#######~~J~~J7?J: ..........................^!!^....................................
// ......................................:~!~:............?J???????J!^:7J??J~~777^^######JGG^#?B######7^7^^7^???........................:~!~:......................................
// .........................................:~!~:........?J?????????J~ 777?J!^7777:B#####YG&?&YG######?~?!^~:??J7 ...................:~!~:.........................................
// ............................................:~!~^:.. !J????????????.:!7?J7^JJ?J:P#####GY5~#GY######?^?7:~:J??J^ ..............:^~!~:............................................
// ...............................................:^!!::J??????????!?J^~J???7:!!!!:J######57PB&J######J:7~:!:J????...........:^~!!^:...............................................
// ....................................................??????????J!~~J:7J????:???J~!#######PPYPG######Y^J?:?.????J! .....:^~!!^:...................................................
// .................................................. ^?7????????J!:7!.?????J:!7!!~^#########B########5.^^.?.7J???J^.^~!~~^:.......................................................
// ...................................................?^7?????????7:?:!J????J:~7777:##################5:~^.?.!??????.::............................................................
// ................................................. :~~J?????????J^^:??????J^~JJJ?:B#################Y:?7:7 ^?77??J7 .............................................................
// ................................................. ^^???????????J7 .??????J~:7!!!.BB5P##############J.^:.! ~!~?????^ ............................................................
// ................................................. :?????????????J:^!?????J!:?7??:7?5B##############?:~~.?.:!J?????~  ...........................................................
// ................................................  7J????????7?J?J~^??????J!:J???:P#################7:!!:7.?J??????J^ ...........................................................
// ................................................ .J?????????7~7JJ~^J?????J7.!!!~.G#################!^^:.7:J????????J^ ..........................................................
// ................................................ ^J?????????J7^!J~:J??????7:???J:G#################~~!~.7:J?????????J...........................................................

// SPDX-License-Identifier: MIT

pragma solidity ^0.8.4;

import "@openzeppelin/contracts/utils/cryptography/ECDSA.sol";
import "@openzeppelin/contracts/utils/cryptography/SignatureChecker.sol";
import "@openzeppelin/contracts/access/AccessControl.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import '@openzeppelin/contracts/token/ERC721/IERC721.sol';

import "./ERC721A.sol";

contract WitchyGF is ERC721A, AccessControl {
    using Strings for uint256;
    using ECDSA for bytes32;

    address constant FREE_SIGNER = 0x0A3B6998165Cc5551b766f0A6e1e305B5A98Cca6;
    address constant PRESLAE_SIGNER = 0xd1769411FC2DDb050a99011d9a41320C6013eC74;
    IERC721 constant DEEBIES_CONTRACT =  IERC721(0x400E2073B4Ac13D6f11c15697DF7Fc609dB93809);


    uint256 public constant MAX_SUPPLY = 7890;
    uint256 public constant MINT_PRICE = 0.0678 ether;

    uint256 public constant  FREE_MINTS = 1;
    uint256 public constant  PRESALE_MINTS = 2;

    struct SaleState {
        bool freeMintActive;
        bool preSaleActive;
        bool publicSaleActive;
    }

    string baseURI;
    SaleState saleState;

    address ownerAddress;

    mapping(bytes32 => uint8) private usedMints;

    constructor(string memory name, string memory symbol, string memory baseURI_, address ownerAddress_) ERC721A(name, symbol) {
        _setupRole(DEFAULT_ADMIN_ROLE, _msgSender());
        _setupRole(DEFAULT_ADMIN_ROLE, ownerAddress_);

        baseURI = baseURI_;
        ownerAddress = ownerAddress_;
    }

    modifier withinSupply(uint256 count) {
        require(count + _totalMinted() < MAX_SUPPLY, "Mint count exceeds max supply");
        _;
    }


    function owner() public view virtual returns (address) {
        return ownerAddress;
    }

    function changeOwner(address newOwner) external onlyRole(DEFAULT_ADMIN_ROLE) {
        ownerAddress = newOwner;
    }

    function vipMint(address[] calldata to) external onlyRole(DEFAULT_ADMIN_ROLE) withinSupply(to.length) {
        for (uint256 index = 0; index < to.length; index++) {
            _safeMint(to[index], 1);
        }
    }

    function _baseURI() internal view virtual override returns (string memory) {
        return baseURI;
    }


    function setSaleState(SaleState calldata state) external onlyRole(DEFAULT_ADMIN_ROLE) {
        saleState.freeMintActive = state.freeMintActive;
        saleState.preSaleActive = state.preSaleActive;
        saleState.publicSaleActive = state.publicSaleActive;
    }


    function presaleMint(uint256 count, bytes memory signature) external payable withinSupply(count) {

        uint256 allowedMints;
        uint256 price;
        
        bytes32 hashedSignature = keccak256(signature);

        (allowedMints, price) = validateSignature(signature, hashedSignature);


        require(count <= allowedMints, "Exceeds allowed mints");
        require(msg.value >= count * price, "ETH is below mint price");


        usedMints[hashedSignature] += uint8(count);
        
        _safeMint(msg.sender, count);
    }

    function publicMint(uint256 count) external payable withinSupply(count) {
        require(count < 14, "Can only mint 13 in one TX");
        require(msg.value >= count * MINT_PRICE, "ETH is below mint price");
        require(saleState.publicSaleActive, "Sale is not active");

        _safeMint(msg.sender, count);
    }

    function getHash() internal view returns (bytes32) {
        return keccak256(abi.encodePacked("WGFS", msg.sender));
    }

    function recover(bytes32 hash, bytes memory signature)
        internal
        pure
        returns (address)
    {
        return hash.toEthSignedMessageHash().recover(signature);
    }

    function validateSignature(bytes memory signature, bytes32 hashedSignature)
        internal
        view
        returns (uint256, uint256)
    {
        bytes32 hash = getHash();
        
        address signer = recover(hash, signature);

        SaleState storage sale = saleState;


        uint256 mintablePresale;
        uint256 price = MINT_PRICE;
        
        if (signer == FREE_SIGNER) {
            require(sale.freeMintActive, "Freesale is not active");
            mintablePresale = FREE_MINTS;
            price = 0;
        } else if (signer == PRESLAE_SIGNER) {
            require(sale.preSaleActive, "Presale is not active");
            
            uint256 deebiesBalance = DEEBIES_CONTRACT.balanceOf(msg.sender);

            mintablePresale = PRESALE_MINTS + deebiesBalance;
        } else {
            revert("Invalid signature. Not on any lists");
        }

        uint16 used = usedMints[hashedSignature];

        require(used < mintablePresale, "Exceeds allowed mints");
        return (mintablePresale - used, price);
    }

    function supportsInterface(bytes4 interfaceId) public view virtual override(ERC721A, AccessControl) returns (bool) {
        return super.supportsInterface(interfaceId) || AccessControl.supportsInterface(interfaceId);
    }

    function withdrawERC20(IERC20 token, address to) external onlyRole(DEFAULT_ADMIN_ROLE) {
        token.transfer(to, token.balanceOf(address(this)));
    }

    function withdrawERC721(IERC721 token, uint256 tokenId, address to) external onlyRole(DEFAULT_ADMIN_ROLE) {
        token.transferFrom(address(this), to, tokenId);
    }

    function withdrawAll() public payable onlyRole(DEFAULT_ADMIN_ROLE) {
        uint256 balance = address(this).balance;

        payable(_msgSender()).transfer(balance);
    }

    function setBaseURI(string memory _baseTokenURI) external onlyRole(DEFAULT_ADMIN_ROLE)  {
        baseURI = _baseTokenURI;
    }
}