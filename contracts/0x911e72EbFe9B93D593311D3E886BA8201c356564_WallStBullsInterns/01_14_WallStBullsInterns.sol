// SPDX-License-Identifier: MIT
/******
 __          __   _ _    _____ _                 _     ____        _ _       _____       _
 \ \        / /  | | |  / ____| |               | |   |  _ \      | | |     |_   _|     | |
  \ \  /\  / /_ _| | | | (___ | |_ _ __ ___  ___| |_  | |_) |_   _| | |___    | |  _ __ | |_ ___ _ __ _ __  ___
   \ \/  \/ / _` | | |  \___ \| __| '__/ _ \/ _ \ __| |  _ <| | | | | / __|   | | | '_ \| __/ _ \ '__| '_ \/ __|
    \  /\  / (_| | | |  ____) | |_| | |  __/  __/ |_  | |_) | |_| | | \__ \  _| |_| | | | ||  __/ |  | | | \__ \
     \/  \/ \__,_|_|_| |_____/ \__|_|  \___|\___|\__| |____/ \__,_|_|_|___/ |_____|_| |_|\__\___|_|  |_| |_|___/

yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy//syyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyssyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyys.--/syyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyys/..oyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy.----/syyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyys/--..+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy-..-----/oyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy+:----..+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy/`..----...:+syyyyyyyyyyyo+//::::://+osyyyyyyyyyo:..----..`+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyys.`..---..```..+++osyy+/:----::-:-:----:/osoo+/.``.----..`.yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy:``......```.:///::-:-:::::::::::::::::----///-.`......``+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyys.```....``-/+++//::://///////////////////:--:/:.....```:yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyo.`..:://::::::::///++//////+++++++////++//:-:/::/+/:-.yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyys:-///os/-/++/://++++////+++++++++++//////+/::/:-hyh:://syyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy+://-.+dd+:/::::++///+osoo///++++++//osyyyo///:-::+sm-`-/:+syyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyo://-...-ho:::.://+:+hmNNNNNNds:/++/:smNNmmmNmh//:/::+o:::///:+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy:////////:-h:+::/++:oNNmys++ymNNy:++:hNNd+s::omNd:/-+/s+oo+++oosyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy+++oooosyy/::/-+++/:NNN/.y+``+NNN:++:NNN/.oo``yNN++:-/syyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyys/.-./+++//dmN-``-``/NNm:++-dmNy.```-dNm:+/:yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy+.-::.+++++-ohmmo:-:omNmy.::-:ydmmhhdmmdo:++-yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyys--::sh-+++++/:/shddmmddho:/+++/:/+ossso+:/+++-yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy+.-::hd+-+++++++/:://////://////////::://+++///-yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy:.-::hh+m-////+++++++//::/+ooooooooossso/:/+//:-/yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy--:::yd+mho-:///++++++//oyyysosyyyyyy+:+yyy/:/:-++syyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy--:::om+ddom/.-:///++/:oyyyyo-..:yyyy+.-/yyyyo-:-+d/yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyysssyyyyysoyyyyy:-::::myoN+ms:-.-:///:/yyyyyyyo++oyyyyyssyyyyyys--:N:yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyy++sssooooos+syyyo.::::/Nohdom:::-.-:::syyyyyyyyyyyyyyyyyyyyyyyyyyo.-N:yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyy/oyyyyyyyyyo+yyyy--::::/N+dhsm::---.-.oyyyyyyyyyyyyyyyyyyyyyyyyyyyy:-N:yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyysssoo.osyyyso+++syys/:.::::::msym+N+:----..ssyyyyyyyyyyyyyysssyysyyyssss-/m:yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyo+//////:::/+///oyyyy/---.::::::sd+mohh::----./+ooosyysssso++osso+++++++//--yy+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyy+/:/ossyyyyoo++osyyyys:-::--:::::::dssm+my::----.-://+++++/:/ooo+//:/-.----.--d:yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyy:/:oyyyyyyyyyyyyyyyyys--:::--:::::::+moyd+dh::-----.------..----:+::++--------:+/oyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyy//:oyyyyyyyyyyyyyo+///--::::--::::::::omoyd+dd/::-----------------:+oh:-------:--s+oyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyy-/-syyyyyyyyyys/::///--:::::/-:::::::::omosdohm+::::----------------:ho---:::::-::y/syyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyy/:/:yyyyyyyys/::::+oo.::::/yho-:::::::--smsomsym+:::::--:::------::--sy:::----::::-/-/osyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyy/-::/++++/:-::-+yyys.:::/dsdy/-::::----.+my+myym+:::::-------.------sd:------::::::::/ho+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyo:--::::--:/oyyyyyo.:::dsmsm+.-:::::---.:hd/msym/::::-----.--.-----yh----.--:::-:::::/mo+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyysssyyyyyyyyyyyo.::shhyms::--::::----.-hh+Noyd/:::----........-:m/.-..-------+++/:-msh+yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyys.::hsmsN/:::----------.-hyomsymo::------------:++...-.---.:oyyyyyyso+s/yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy

******/

pragma solidity ^0.8.4;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/cryptography/MerkleProof.sol";
import "./ERC721EnumerableV2.sol";

contract WallStBullsInterns is ERC721EnumerableV2, Ownable {

    uint256 public constant RESERVED_INTERNS = 100;

    mapping(address => uint256) public totalMinted;
    string public baseURI;
    bool public baseURIFinal;
    bool public saleActive;

    bytes32 private _eligibilityMerkleRoot;

    event BaseURIChanged(string baseURI);
    event PermanentURI(string _value, uint256 indexed _id);

    constructor(string memory _initialBaseURI) ERC721("Wall Street Bulls Interns", "WSBI")  {
        baseURI = _initialBaseURI;
    }

    function setBaseURI(string memory _newBaseURI) external onlyOwner {
        require(!baseURIFinal, "Base URL is unchangeable");
        baseURI = _newBaseURI;
        emit BaseURIChanged(baseURI);
    }

    function finalizeBaseURI() external onlyOwner {
        baseURIFinal = true;
    }

    function _baseURI() internal view virtual override returns (string memory) {
        return baseURI;
    }

    function emitPermanent(uint256 tokenId) external onlyOwner {
        require(baseURIFinal, "Base URL must be finalized first");
        emit PermanentURI(tokenURI(tokenId), tokenId);
    }

    function toggleSaleActive() external onlyOwner {
        saleActive = !saleActive;
    }

    function setEligibilityMerkleRoot(bytes32 _merkleRoot) external onlyOwner {
        _eligibilityMerkleRoot = _merkleRoot;
    }

    function mintReserved(address _to, uint256 _internCount) external onlyOwner {
        require(totalMinted[msg.sender] + _internCount <= RESERVED_INTERNS, "All Reserved Interns have been minted");
        _mintIntern(_to, _internCount);
    }

    function withdraw(address _to, uint256 _amount) external onlyOwner {
        (bool success,) = _to.call{value : _amount}("");
        require(success, "Failed to withdraw Ether");
    }

    function _verifyInternEligible(address _account, uint8 _maxAllowed, bytes32[] calldata _merkleProof) private view returns (bool) {
        bytes32 node = keccak256(abi.encodePacked(_account, _maxAllowed));
        return MerkleProof.verify(_merkleProof, _eligibilityMerkleRoot, node);
    }

    function mintIntern(uint256 _internCount, uint8 _maxAllowed, bytes32[] calldata _merkleProof) external payable {
        require(saleActive, "Sale is not active");
        require(_verifyInternEligible(msg.sender, _maxAllowed, _merkleProof), "Address not found in eligibility allow list");
        require(totalMinted[msg.sender] + _internCount <= uint256(_maxAllowed), "Purchase exceeds max mint count");

        _mintIntern(msg.sender, _internCount);
    }

    function _mintIntern(address _to, uint256 _internCount) private {
        uint256 totalSupply = totalSupply();
        require(_internCount > 0, "Must mint at least one Intern");

        for (uint256 i = 1; i <= _internCount; i++) {
            totalMinted[msg.sender] += 1;
            _safeMint(_to, totalSupply + i);
        }
    }
}