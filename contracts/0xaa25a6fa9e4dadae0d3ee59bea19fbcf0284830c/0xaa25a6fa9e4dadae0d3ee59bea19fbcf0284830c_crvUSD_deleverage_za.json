{"SourceCode": "# @version 0.3.9\r\n\r\n\"\"\"\r\n@title crvUSD deleverage zap\r\n@author Curve.Fi\r\n@license Copyright (c) Curve.Fi, 2020-2023 - all rights reserved\r\n\"\"\"\r\n\r\ninterface ERC20:\r\n    def balanceOf(_for: address) -> uint256: view\r\n    def approve(_spender: address, _value: uint256) -> bool: nonpayable\r\n    def decimals() -> uint256: view\r\n\r\ninterface Router:\r\n    def exchange(_route: address[11], _swap_params: uint256[5][5], _amount: uint256, _expected: uint256, _pools: address[5]) -> uint256: payable\r\n    def get_dy(_route: address[11], _swap_params: uint256[5][5], _amount: uint256, _pools: address[5]) -> uint256: view\r\n\r\ninterface Controller:\r\n    def calculate_debt_n1(collateral: uint256, debt: uint256, N: uint256) -> int256: view\r\n    def user_state(user: address) -> uint256[4]: view\r\n\r\n\r\nCRVUSD: constant(address) = 0xf939E0A03FB07F59A73314E73794Be0E57ac1b4E\r\n\r\nCONTROLLER: public(immutable(address))\r\nCOLLATERAL: public(immutable(address))\r\nROUTER: public(immutable(address))\r\n\r\nroutes: public(HashMap[uint256, address[11]])\r\nroute_params: public(HashMap[uint256, uint256[5][5]])\r\nroute_pools: public(HashMap[uint256, address[5]])\r\nroute_names: public(HashMap[uint256, String[100]])\r\nroutes_count: public(constant(uint256)) = 5\r\n\r\n\r\n@external\r\ndef __init__(\r\n        _controller: address,\r\n        _collateral: address,\r\n        _router: address,\r\n        _routes: DynArray[address[11], 5],\r\n        _route_params: DynArray[uint256[5][5], 5],\r\n        _route_pools: DynArray[address[5], 5],\r\n        _route_names: DynArray[String[100], 5],\r\n):\r\n    CONTROLLER = _controller\r\n    COLLATERAL = _collateral\r\n    ROUTER = _router\r\n\r\n    for i in range(5):\r\n        self.routes[i] = _routes[i]\r\n        self.route_params[i] = _route_params[i]\r\n        self.route_pools[i] = _route_pools[i]\r\n        self.route_names[i] = _route_names[i]\r\n\r\n    ERC20(_collateral).approve(_router, max_value(uint256), default_return_value=True)\r\n    ERC20(_collateral).approve(_controller, max_value(uint256), default_return_value=True)\r\n    ERC20(CRVUSD).approve(_controller, max_value(uint256), default_return_value=True)\r\n\r\n\r\n@view\r\n@external\r\ndef get_stablecoins(collateral: uint256, route_idx: uint256) -> uint256:\r\n    return Router(ROUTER).get_dy(self.routes[route_idx], self.route_params[route_idx], collateral, self.route_pools[route_idx])\r\n\r\n\r\n@external\r\n@view\r\ndef calculate_debt_n1(collateral: uint256, route_idx: uint256, user: address) -> int256:\r\n    \"\"\"\r\n    @notice Calculate the upper band number after deleverage repay, which means that\r\n            collateral from user's position is converted to stablecoins to repay the debt.\r\n    @param collateral Amount of collateral (at its native precision).\r\n    @param route_idx Index of the route which should be use for exchange stablecoin to collateral.\r\n    @return Upper band n1 (n1 <= n2) to deposit into. Signed integer.\r\n    \"\"\"\r\n    deleverage_collateral: uint256 = Router(ROUTER).get_dy(self.routes[route_idx], self.route_params[route_idx], collateral, self.route_pools[route_idx])\r\n    state: uint256[4] = Controller(CONTROLLER).user_state(user)  #collateral, stablecoin, debt, N\r\n    assert state[1] == 0, \"Underwater, only full repayment is allowed\"\r\n    assert deleverage_collateral < state[2], \"Full repayment, position will be closed\"\r\n\r\n    return Controller(CONTROLLER).calculate_debt_n1(state[0] - collateral, state[2] - deleverage_collateral, state[3])\r\n\r\n\r\n@external\r\n@nonreentrant('lock')\r\ndef callback_repay(user: address, stablecoins: uint256, collateral: uint256, debt: uint256, callback_args: DynArray[uint256, 5]) -> uint256[2]:\r\n    \"\"\"\r\n    @notice Callback method which should be called by controller to repay by selling collateral\r\n    @param user Address of the user\r\n    @param stablecoins Amount of user's stablecoin in AMM\r\n    @param collateral Amount of user's collateral in AMM\r\n    @param debt Current debt amount\r\n    @param callback_args [route_idx, collateral_amount, min_recv]\r\n    return [deleverage_stablecoins, (collateral - collateral_amount)], deleverage_stablecoins is\r\n    the amount of stablecoins got as a result of selling collateral\r\n    \"\"\"\r\n    assert msg.sender == CONTROLLER\r\n\r\n    route_idx: uint256 = callback_args[0]\r\n    collateral_amount: uint256 = callback_args[1]\r\n    min_recv: uint256 = callback_args[2]\r\n    deleverage_stablecoins: uint256 = Router(ROUTER).exchange(self.routes[route_idx], self.route_params[route_idx], collateral_amount, min_recv, self.route_pools[route_idx])\r\n\r\n    return [deleverage_stablecoins, ERC20(COLLATERAL).balanceOf(self)]", "ABI": "[{\"stateMutability\":\"nonpayable\",\"type\":\"constructor\",\"inputs\":[{\"name\":\"_controller\",\"type\":\"address\"},{\"name\":\"_collateral\",\"type\":\"address\"},{\"name\":\"_router\",\"type\":\"address\"},{\"name\":\"_routes\",\"type\":\"address[11][]\"},{\"name\":\"_route_params\",\"type\":\"uint256[5][5][]\"},{\"name\":\"_route_pools\",\"type\":\"address[5][]\"},{\"name\":\"_route_names\",\"type\":\"string[]\"}],\"outputs\":[]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"get_stablecoins\",\"inputs\":[{\"name\":\"collateral\",\"type\":\"uint256\"},{\"name\":\"route_idx\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"calculate_debt_n1\",\"inputs\":[{\"name\":\"collateral\",\"type\":\"uint256\"},{\"name\":\"route_idx\",\"type\":\"uint256\"},{\"name\":\"user\",\"type\":\"address\"}],\"outputs\":[{\"name\":\"\",\"type\":\"int256\"}]},{\"stateMutability\":\"nonpayable\",\"type\":\"function\",\"name\":\"callback_repay\",\"inputs\":[{\"name\":\"user\",\"type\":\"address\"},{\"name\":\"stablecoins\",\"type\":\"uint256\"},{\"name\":\"collateral\",\"type\":\"uint256\"},{\"name\":\"debt\",\"type\":\"uint256\"},{\"name\":\"callback_args\",\"type\":\"uint256[]\"}],\"outputs\":[{\"name\":\"\",\"type\":\"uint256[2]\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"CONTROLLER\",\"inputs\":[],\"outputs\":[{\"name\":\"\",\"type\":\"address\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"COLLATERAL\",\"inputs\":[],\"outputs\":[{\"name\":\"\",\"type\":\"address\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"ROUTER\",\"inputs\":[],\"outputs\":[{\"name\":\"\",\"type\":\"address\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"routes\",\"inputs\":[{\"name\":\"arg0\",\"type\":\"uint256\"},{\"name\":\"arg1\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"\",\"type\":\"address\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"route_params\",\"inputs\":[{\"name\":\"arg0\",\"type\":\"uint256\"},{\"name\":\"arg1\",\"type\":\"uint256\"},{\"name\":\"arg2\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"route_pools\",\"inputs\":[{\"name\":\"arg0\",\"type\":\"uint256\"},{\"name\":\"arg1\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"\",\"type\":\"address\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"route_names\",\"inputs\":[{\"name\":\"arg0\",\"type\":\"uint256\"}],\"outputs\":[{\"name\":\"\",\"type\":\"string\"}]},{\"stateMutability\":\"view\",\"type\":\"function\",\"name\":\"routes_count\",\"inputs\":[],\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}]}]", "ContractName": "crvUSD deleverage zap", "CompilerVersion": "vyper:0.3.9", "OptimizationUsed": "0", "Runs": "0", "ConstructorArguments": "0000000000000000000000008472a9a7632b173c8cf3a86d3afec50c35548e76000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f000000000000000000000000f0d4c12a5768d806021f80a262b4d39d26c58b8d00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000007e000000000000000000000000000000000000000000000000000000000000017a00000000000000000000000000000000000000000000000000000000000001ae00000000000000000000000000000000000000000000000000000000000000005000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f0000000000000000000000005e8422345238f34275888049021821e8e08caa1f000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e577000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f86bf177dd4f3494b841a37e810a34dd56c829b000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000004dece678ceceb27446b35c672dc7d61f30bad69e000000000000000000000000f939e0a03fb07f59a73314e73794be0e57ac1b4e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f0000000000000000000000005e8422345238f34275888049021821e8e08caa1f000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e577000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000d51a44d3fae010294c616388b506acda1bfaae46000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000390f3595bca2df7d23783dfd126427cceb997bf4000000000000000000000000f939e0a03fb07f59a73314e73794be0e57ac1b4e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f0000000000000000000000005e8422345238f34275888049021821e8e08caa1f000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e577000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000004ebdf703948ddcea3b11f675b4d1fba9d2414a14000000000000000000000000f939e0a03fb07f59a73314e73794be0e57ac1b4e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f0000000000000000000000005e8422345238f34275888049021821e8e08caa1f000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e577000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000d51a44d3fae010294c616388b506acda1bfaae46000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000ecd5e75afb02efa118af914515d6521aabd189f10000000000000000000000000000000000085d4780b73119b644ae5ecd22b37600000000000000000000000034d655069f4cac1547e4c8ca284ffff5ad4a8db0000000000000000000000000f939e0a03fb07f59a73314e73794be0e57ac1b4e000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f000000000000000000000000ac3e018457b222d93114458476f3e3416abbe38f0000000000000000000000005e8422345238f34275888049021821e8e08caa1f000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e577000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000d51a44d3fae010294c616388b506acda1bfaae46000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000d632f22692fac7611d2aa1c0d552930d43caed3b000000000000000000000000853d955acef822db058eb8505911ed77f175b99e0000000000000000000000000cd6f267b2086bea681e922e19d40512511be538000000000000000000000000f939e0a03fb07f59a73314e73794be0e57ac1b4e00000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e5770000000000000000000000007f86bf177dd4f3494b841a37e810a34dd56c829b0000000000000000000000004dece678ceceb27446b35c672dc7d61f30bad69e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e577000000000000000000000000d51a44d3fae010294c616388b506acda1bfaae46000000000000000000000000390f3595bca2df7d23783dfd126427cceb997bf400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e5770000000000000000000000004ebdf703948ddcea3b11f675b4d1fba9d2414a14000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e577000000000000000000000000d51a44d3fae010294c616388b506acda1bfaae46000000000000000000000000ecd5e75afb02efa118af914515d6521aabd189f100000000000000000000000034d655069f4cac1547e4c8ca284ffff5ad4a8db00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a1f8a6807c402e4a15ef4eba36528a3fed24e577000000000000000000000000d51a44d3fae010294c616388b506acda1bfaae46000000000000000000000000d632f22692fac7611d2aa1c0d552930d43caed3b0000000000000000000000000cd6f267b2086bea681e922e19d40512511be538000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000004f736672784554482077726170706572202d3e20667278657468202d3e20666163746f72792d74726963727970746f2d30202854726963727970746f5553444329202d3e206372765553442f5553444300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000036736672784554482077726170706572202d3e20667278657468202d3e2074726963727970746f32202d3e206372765553442f55534454000000000000000000000000000000000000000000000000000000000000000000000000000000000039736672784554482077726170706572202d3e20667278657468202d3e20666163746f72792d74726963727970746f2d3420285472694352562900000000000000000000000000000000000000000000000000000000000000000000000000003e736672784554482077726170706572202d3e20667278657468202d3e2074726963727970746f32202d3e2074757364202d3e206372765553442f545553440000000000000000000000000000000000000000000000000000000000000000003e736672784554482077726170706572202d3e20667278657468202d3e2074726963727970746f32202d3e2066726178202d3e206372765553442f465241580000", "EVMVersion": "Default", "Library": "", "LicenseType": "None", "Proxy": "0", "Implementation": "", "SwarmSource": ""}