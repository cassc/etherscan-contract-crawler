// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##############################################################@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##############################################################@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##############################################################@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##############################################################@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@##########(*************************************************************###########@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@##########(*************************************************************###########@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@##########(*************************************************************###########@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@###########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###########@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@##########***********@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@***********##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########***********@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@***********##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########***********@@@@@@@@@@#########################################@@@@@@@@@@***********##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@*****************************************@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@*****************************************@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@*****************************************@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@*****************************************@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@*****************************************@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@#########################################@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@*****************************************@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@##########@@@@@@@@@@@@@@@@@@@@@*****************************************@@@@@@@@@@@@@@@@@@@@@##########@@@@@@@@@@@@
// @@@@@@@@@@@@@**********###########@@@@@@@@@@*****************************************@@@@@@@@@@###########**********@@@@@@@@@@@@
// @@@@@@@@@@@@@**********###########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###########**********@@@@@@@@@@@@
// @@@@@@@@@@@@@**********###########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###########**********@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@###########@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###########@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@**********/#############################################################***********@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@**********/#############################################################***********@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@**********/#############################################################***********@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##############################################################@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@**************************************************************@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@**************************************************************@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@**************************************************************@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//
// MultiPass
//
// Entities special edition collection
// https://entities.wtf
//
// SPDX-License-Identifier: MIT

pragma solidity ^0.8.0;
pragma abicoder v2;

import '@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol';
import '@openzeppelin/contracts/access/Ownable.sol';
import "./@rarible/royalties/contracts/impl/RoyaltiesV2Impl.sol";
import "./@rarible/royalties/contracts/LibPart.sol";
import "./@rarible/royalties/contracts/LibRoyaltiesV2.sol";

contract MultiPass is ERC721Enumerable, RoyaltiesV2Impl, Ownable{
    
    using Strings for uint256;
    event Burned (uint tokenId, address);
    string public MULTIPASS_PROVENANCE = "";
    string private _baseContractURI = "https://gateway.pinata.cloud/ipfs/QmfR7WdrZcfihrZSFUqXWz6LW2NZXDzu9Vjt1WzZDzk4y5"; 
    string private _baseTokenURI = "https://entitieswtf.herokuapp.com/api/token/"; 
    uint256 public constant MAX_MULTIPASSES = 10000;
    uint256 private multiPassesReserved; 
    uint256 public constant maxMultiPassesPurchase = 20;
    uint256 private multiPassPrice = 100000000000000000; // 0.1 ETH
    bool public mintingAllowed = true;
    bool public burningAllowed = false;
    bool public salePaused = true;
    mapping (address => uint) private _MultiPassBurners;
    uint96 public constant royaltyFeeBps = 1000; // 10%
    address payable public payoutAddress;

    // Team - 10%
    address t1;
    address t2;
    address t3;
    address t4;
    // Entities Treasury - 90%
    address t5;

    constructor(
        address _t1,
        address _t2,
        address _t3,
        address _t4,
        address _t5
        
        ) ERC721("MultiPass", "MULTI")  {
        payoutAddress = payable(msg.sender);
        t1 = _t1;
        t2 = _t2;
        t3 = _t3;
        t4 = _t4;
        t5 = _t5;
    }
  
    function burn(uint256 tokenId) public virtual {
        require(burningAllowed == true, "Burning is not yet allowed");
        require(_isApprovedOrOwner(_msgSender(), tokenId), "One cannot burn what one does not own");
            _burn(tokenId);
            _MultiPassBurners[msg.sender] = tokenId;
            emit Burned(tokenId, msg.sender);
    }

    function mintMultiPass(uint256 num) public payable {
        require(mintingAllowed == true, "Minting has ended");
        require(totalSupply() < MAX_MULTIPASSES, "Sale has already ended" );
        require( !salePaused, "Sale paused" );
        require(num > 0 && num <= maxMultiPassesPurchase, "You can mint minimum 1, maximum 20 MultiPasses");
        require( totalSupply() + num <= MAX_MULTIPASSES, "Exceeds maximum MultiPass supply" );
        require( msg.value >= multiPassPrice * num, "Ether sent is not correct" );

        for(uint256 i = 0; i < num; i++){
            uint mintIndex = totalSupply();
            _safeMint( msg.sender, mintIndex );
            setRoyalties(mintIndex, payoutAddress, royaltyFeeBps);
        }
    }

    function walletOfOwner(address _owner) public view returns(uint256[] memory) {
        uint256 tokenCount = balanceOf(_owner);
        uint256[] memory tokensId = new uint256[](tokenCount);

        for(uint256 i; i < tokenCount; i++){
            tokensId[i] = tokenOfOwnerByIndex(_owner, i);
        }
        return tokensId;
    }
    
    function contractURI() public view returns (string memory) {
        return _baseContractURI;
    }
    
    function _baseURI() internal view virtual override returns (string memory) {
        return _baseTokenURI;
    }

    function getPrice() public view returns (uint256){
        return multiPassPrice;
    }
    
   function setRoyalties(uint _tokenId, address payable _royaltiesReceipientAddress, uint96 _percentageBasisPoints) internal {
        LibPart.Part[] memory _royalties = new LibPart.Part[](1);
        _royalties[0].value = _percentageBasisPoints;
        _royalties[0].account = _royaltiesReceipientAddress;
        _saveRoyalties(_tokenId, _royalties);
    }

    function supportsInterface(bytes4 interfaceId) public view virtual override(ERC721Enumerable) returns (bool) {
        if(interfaceId == LibRoyaltiesV2._INTERFACE_ID_ROYALTIES) {
            return true;
        }
        return super.supportsInterface(interfaceId);
    } 
    
    // Owner only functions
    
    function setBaseContractURI(string memory baseContractURI) public onlyOwner {
        _baseContractURI = baseContractURI;
    }


    function setProvenanceHash(string memory provenanceHash) public onlyOwner {
        MULTIPASS_PROVENANCE = provenanceHash;
    }

    function setPrice(uint256 _newPrice) public onlyOwner() {
        multiPassPrice = _newPrice;
    }

    function setBaseURI(string memory baseURI) public onlyOwner {
        _baseTokenURI = baseURI;
    }
    
    function setRaribleRoyaltyWallet(address payable royaltyWallet) public onlyOwner {
        payoutAddress = royaltyWallet;
    }
    
    function setBaseReservedMultiPasses(uint baseReservedMultiPasses) public onlyOwner {
        multiPassesReserved = baseReservedMultiPasses;
    }

    function reserveAirdropMultiPasses(uint256 _amount) external onlyOwner() {
        uint256 currentSupply = totalSupply();
        require( totalSupply() + _amount <= multiPassesReserved, "Exceeds reserved MultiPass supply" );
        require(salePaused == true, "MultiPass minting has already started");

        for(uint256 i = 0; i < _amount; i++){
            uint mintIndex = currentSupply;
            _safeMint( owner(), mintIndex + i );
            setRoyalties(mintIndex + i, payoutAddress, royaltyFeeBps);
        }
    }
    
    function pause(bool val) public onlyOwner {
        salePaused = val;
    }
    function setBurnAllowed(bool val) public onlyOwner {
        burningAllowed = val;
    }
    function setMintAllowed(bool val) public onlyOwner {
        mintingAllowed = val;
    }
    
    function setT1Address(address t1Address) public onlyOwner {
        t1 = t1Address;
    }
    function setT2Address(address t2Address) public onlyOwner {
        t2 = t2Address;
    }
    function setT3Address(address t3Address) public onlyOwner {
        t3 = t3Address;
    }
    function setT4Address(address t4Address) public onlyOwner {
        t4 = t4Address;
    }
    function setT5Address(address t5Address) public onlyOwner {
        t5 = t5Address;
    }
  
    
    function withdrawAll() public payable onlyOwner {
        uint sale1 = address(this).balance * 1/100;
        uint sale2 = address(this).balance * 3/100;
        uint sale3 = address(this).balance * 3/100;
        uint sale4 = address(this).balance * 3/100;
        uint sale5 = address(this).balance * 90/100;

        require(payable(t1).send(sale1));
        require(payable(t2).send(sale2));
        require(payable(t3).send(sale3));
        require(payable(t4).send(sale4));
        require(payable(t5).send(sale5));
    }
}