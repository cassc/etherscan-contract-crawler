// SPDX-License-Identifier: UNLICENSED
// ||||||||//|||||///x$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xuuvuvvvvvvvvvvvvvv
// |||||||||||||||||||/|///|/$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||///}$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xcvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||//t $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ zvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||/|/|$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||/|}$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||||||||||||x$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||||||||||||/|/$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$zvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||x$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||/|x$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||x$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/|$$$$$$$$$$$$$$$$$$$$$$$$$$$$$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||t$$$$$$$$$$$$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||t$$$$$$$$$$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/$$$$$$$$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/ $$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/x$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/|x$$$$$$$$$$$$$$$Qvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||//$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||$$$$$$$$$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/| $$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/f$$$$$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||($$$$$uvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/t$$$uvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/($$$uvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||$Yvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$x|||||||||||||||||||||||||||||||||$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvx$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
// $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$/||||||||||||||||||||||||||||/|$$$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
// $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$t|||||||||||||||||||||||||||x$$$$$xuvvvvvvvvvvvvvvvvvvvvvvvvvvv$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxnx$$$$x/|||||||||||||||||||||||/$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvQ$$$$()))))))))))))))))))))))))))))))))))))))(
// $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$nxY$$$ ||||||||||||||||||||||($$$$xft$$$$cvvvvvvvvvvvvvvvvvvvvvv$$$$)))$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
// $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$rxx$$$$|||||||||||||||||||| $$$$xx$))$$$$ vvvvvvvvvvvvvvvvvvvv$$$$))x$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
// $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xx$$$$c||||||||||||||||/$$$$xnu$$${1|$$$$vvvvvvvvvvvvvvvvv$$$$}11$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
// |//////////////////////////////////////$$$$$xxt$$$x/||||||||||||/|$$$$nxY$$$$$)))$$$$zvvvvvvvvvvvvvvx$$$)))$$$$$Jvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||x$$$$unx$$$}|||||||||||/$$$$cxx$$$$$$$$$1) $$$$vvvvvvvvvvvvx$$$1)t$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||/$$$$ nx$$$||||||||||/$$$$xxv$$$|/$}c$$$1))$$$$vvvvvvvvvc$$$ ))$$$$$Qvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||/ $$$$nn$$$$//||||//$$$xxx$$$$/||$vvvQ$$ )) $$$vvvvvvvv$$$ ))$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||x$$$$unQ$$$//|||/$$$xxx$$$}/||/$xvvvu$$$))1$$$vvvvvc$$$})}$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||/$$$$}nx$$$t/||$$$ux $$$//|||/$xvvvvv $$|)|$$$uvvx$$$() $$$$Qvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||/| $$$xxx$$$$$$$}xx$$$$/|||||/$Yvvvvvvx$$$))$$$$$$$x))x$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||/|}$$$xxxx$$$$xxz$$$}|/||||/t$$vvvvvvvX$$$j))$$$$t1)$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||/x$$$$xnv$xnnz$$$t/||||||/x$$vvvvvvvvv$$$})1$$))($$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||t$$$$xxnxn$$$$||||||||//$$$xvvvvvvvvv $$}()))}$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||t$$$$xxu$$$$/||||||||||$$$Qvvvvvvvvvvx$$$))$$$$$xcvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||//$$$$$$$$$|/||||||||/}$$$$vvvvvvvvvvvc$$$$$$$$zvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||/x$$$$$|||||||||||||$$$$$vvvvvvvvvvvvc$$$$$$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||t$$$/|||||||||||/x$$$$$$vvvvvvvvvvvvv}$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||||x//|||||||||||/$$$$$$$Xvvvvvvvvvvvvvxzvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||||/|||||||||||/| $$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/|$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||x$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||Q$$$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/ $$$$$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/|$$$$$$$$$$$$$$$$$$$$$$$Xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||/f$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||||||||||//)$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||||||||||($$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||/|x$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$uvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||||}$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$uvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||||||||||$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$cvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||||||/$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$Uvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||||||||||/|t$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||||||||/}$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$uvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||||||||||||/||/$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||||||||/1$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||||||||||||||/|/f$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$zvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||||||||||||||||||||||||//x$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ccvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
// /|||||||||||||||||||/|/||}$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$cvvvvvvvvvvvvvvvvvvvvvvvv
// /||||||/||///||//t$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$xvvvvvvvvvvvvvvvvv
pragma solidity ^0.8.4 < 0.9.0;

import "./ERC721A.sol";
import "./OpenSeaListing.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/token/common/ERC2981.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/security/Pausable.sol";
import "@openzeppelin/contracts/utils/cryptography/ECDSA.sol";
import "@openzeppelin/contracts/utils/cryptography/draft-EIP712.sol";

contract DDW is ERC721A, EIP712, ERC2981, Ownable, Pausable, ReentrancyGuard {

    address private privilegedMintSignerAddress;
    address private referralMintSignerAddress;
    address public constant openSeaProxyRegistryAddress = 0xa5409ec958C83C3f309868babACA7c86DCB077c1;
    address public metaverseAccessContract = address(0);
    uint96 private royaltyFeeBasisPoints;
    uint96 private referrerEarningBasisPoints;
    string private baseURI;
    string private contracturi;
    string private privilegedStruct;
    string private referralStruct;
    

    uint256 public constant MAX_SUPPLY_plus_1 = 697;
    uint256 public constant MAX_MINT_PER_WALLET = 1;
    uint256 public MAX_ELITE_CHAD_SUPPLY_plus_1 = 21;
    bool public isPublicMintLive;
    bool public isReferralMintLive;
    bool public isBurningActive;
    uint256 public publicMintPrice;
    uint256 public minReferralMintPrice;
    mapping (address => bool) public hasMinted;
    mapping (uint256 => bool) private isPrivilegedToken;
    mapping (address => bool) private proxyToApproved;

    constructor(address privilegedMintSignerAddress_, 
                address referralMintSignerAddress_,
                uint96 royaltyFeeBasisPoints_,
                uint96  referrerEarningBasisPoints_,
                uint256 publicMintPrice_,
                uint256 minReferralMintPrice_,
                string memory referralStruct_,
                string memory privilegedStruct_,
                string memory baseURI_,
                string memory contracturi_
                ) 
                ERC721A("DDW: Chad Card", "CHAD")
                EIP712("DreamDateWorld", "1")
    {
        privilegedMintSignerAddress = privilegedMintSignerAddress_;
        referralMintSignerAddress = referralMintSignerAddress_;
        royaltyFeeBasisPoints = royaltyFeeBasisPoints_;
        referrerEarningBasisPoints = referrerEarningBasisPoints_;
        _setDefaultRoyalty(msg.sender, royaltyFeeBasisPoints_);
        isReferralMintLive = true;
        isPublicMintLive = false;
        isBurningActive = false;
        publicMintPrice = publicMintPrice_;
        minReferralMintPrice = minReferralMintPrice_;
        referralStruct = referralStruct_;
        privilegedStruct = privilegedStruct_;
        baseURI = baseURI_;
        contracturi = contracturi_;

        
    }

    modifier callerIsUser() {
        require(tx.origin == msg.sender, "Only Humans can become a Chad");
        _;
    }

    function pause() public onlyOwner {
        _pause();
    }

    function unpause() public onlyOwner {
        _unpause();
    }

    function _beforeTokenTransfers(
        address from,
        address to,
        uint256 startTokenId,
        uint256 quantity
    )
        internal 
        whenNotPaused
        virtual
        override
    {
        super._beforeTokenTransfers(from, to, startTokenId, quantity);
    }

    function transferOwnership(address newOwner) public onlyOwner virtual override {
        require(newOwner != address(0), "Ownable: new owner is the zero address");
        uint96 royaltyFeeBasisPoints_ = royaltyFeeBasisPoints;
        _setDefaultRoyalty(newOwner, royaltyFeeBasisPoints_);
        super.transferOwnership(newOwner);
    }

    function burn(uint256 tokenId) external {
        require(isBurningActive, "Why so eager for Destruction?");
        require(metaverseAccessContract == msg.sender, "Who is this pretenious contract?");
        _burn(tokenId);
    }

    function isTokenPrivileged(uint256 tokenId) external view returns(bool) {
        return isPrivilegedToken[tokenId];
    }

    // Alpha Chad Public Mint
    function becomeAChad() external payable callerIsUser nonReentrant {
        require(
        isPublicMintLive,
        "Public Mint not actice. You will become a Chad soon"
        );
        require(
        !hasMinted[msg.sender],
        "You are already a Chad"
        );
        require(totalSupply() + MAX_MINT_PER_WALLET < MAX_SUPPLY_plus_1, "Sold out! Become a Chad on Secondary Market");
        require(msg.value > publicMintPrice, "low balance. You dont have what it takes to become a Chad");
        hasMinted[msg.sender] = true;
        _safeMint(msg.sender, MAX_MINT_PER_WALLET);
    }

    // Elite Chad Mint
    function becomeAPartnerChad(bytes memory signature) external payable callerIsUser nonReentrant {
        require(checkIfPrivileged(msg.sender, signature) == privilegedMintSignerAddress,
                "Incorrect referral code. Its not easy to become a Mega Partner Chad"
                );
        require(
        !hasMinted[msg.sender],
        "You are already a Chad"
        );
        require(totalSupply() + MAX_MINT_PER_WALLET < MAX_SUPPLY_plus_1, "Sold out! Become a Chad on Secondary Market");
        require(totalSupply() + MAX_MINT_PER_WALLET < MAX_ELITE_CHAD_SUPPLY_plus_1, "Sold out! Become an Elite Chad on Secondary Market");
        hasMinted[msg.sender] = true;
        isPrivilegedToken[totalSupply()] = true;
        _safeMint(msg.sender, MAX_MINT_PER_WALLET);
    }

    // Alpha Chad R2E Mint
    function becomeAR2EChad(uint256 tokenId, uint256 mintPriceInWei, bytes memory signature) external payable callerIsUser nonReentrant {
        require(checkIfReferral(msg.sender, mintPriceInWei, tokenId, signature) == referralMintSignerAddress,
                "Wrong mint price, tokenId and referral code combination. Its not easy to become a R2E Chad"
                );
        require(
        isReferralMintLive,
        "You will become a Chad soon"
        );
        require(mintPriceInWei > minReferralMintPrice, "low mint price. Your Mega Partner Chad is Kidding with you");
        require(msg.value > mintPriceInWei, "low balance. You dont have what it takes to become a Chad");   
        require(this.isTokenPrivileged(tokenId), 
                "Incorrect Token ID. It requires a Mega Partner Chad for you to become an R2E Chad"
                );
        require(
        !hasMinted[msg.sender],
        "You are already a Chad"
        );
        require(totalSupply() + MAX_MINT_PER_WALLET < MAX_SUPPLY_plus_1, "Sold out! Become a Chad on Secondary Market");
        hasMinted[msg.sender] = true;
        _safeMint(msg.sender, MAX_MINT_PER_WALLET);
        address payable referrer = payable(ownerOf(tokenId));
        (bool success, bytes memory returnData) = referrer.call{
                value: msg.value*referrerEarningBasisPoints/10000
            }("");
        require(success, string(returnData));

    }

    function checkIfPrivileged(address wallet, bytes memory signature) internal view returns (address) {
        bytes32 digest = _hashTypedDataV4(keccak256(abi.encode(
        keccak256(bytes(privilegedStruct)),
        wallet)));
        return ECDSA.recover(digest, signature);
    }

    function checkIfReferral(address wallet, uint256 mintPrice, uint256 tokenId, bytes memory signature) 
    internal view returns (address) {
        bytes32 digest = _hashTypedDataV4(keccak256(abi.encode(
        keccak256(bytes(referralStruct)),
        wallet,
        mintPrice,
        tokenId)));
        return ECDSA.recover(digest, signature);
    }

    function totalEliteSupply() external view returns (uint256) {
        uint256 j = 0;
        for(uint256 i = _startTokenId(); i < _nextTokenId(); i++) {
            if (!_exists(i))
            continue;
            if (isPrivilegedToken[i]) {
                j++;
            }
        }

        return j;
    }

    function tokensOf(address wallet) external view returns (uint256[] memory) {
        if (balanceOf(wallet) == 0)
        return new uint256[](0);
        uint256 balance_ = balanceOf(wallet);
        uint256[] memory tokenIds = new uint256[](balance_);
        uint256 j = 0;
        for(uint256 i = _startTokenId(); i < _nextTokenId(); i++) {
            if (!_exists(i))
            continue;
            if (ownerOf(i) == wallet) {
                tokenIds[j] = i;
                j++;
            }
        }

        return tokenIds;
    }

     function _baseURI() internal view virtual override returns (string memory) {
        return baseURI;
    }

    function setBaseURI(string memory URI) external onlyOwner {
      baseURI = URI;
    }

    function viewBaseURI() external view returns(string memory) {
      return _baseURI();
    }

    function tokenURI(uint256 tokenId) public view virtual override returns (string memory) {
        if (!_exists(tokenId)) revert URIQueryForNonexistentToken();

        string memory baseURI_ = _baseURI();
        if (this.isTokenPrivileged(tokenId))
        return bytes(baseURI_).length != 0 ? string(abi.encodePacked(baseURI_, "EliteChad.json")) : '';
        return bytes(baseURI_).length != 0 ? string(abi.encodePacked(baseURI_, "AlphaChad.json")) : '';
    }

    function contractURI() public view returns (string memory) {
        return contracturi;
    }

    function setEliteMaxSupply(uint256 eliteMaxSupply) external onlyOwner {
        MAX_ELITE_CHAD_SUPPLY_plus_1 = eliteMaxSupply + 1;
    }

    function setcontractURI(string memory URI) external onlyOwner {
      contracturi = URI;
    }

    function setRoyaltyInfo(address receiver, uint96 feeBasisPoints)
        external
        onlyOwner
    {
        _setDefaultRoyalty(receiver, feeBasisPoints);
    }

    function toggleReferralMintStatus() external onlyOwner {
        isReferralMintLive = !isReferralMintLive;
    }

    function togglePublicMintStatus() external onlyOwner {
        isPublicMintLive = !isPublicMintLive;
    }

    function toggleBurningStatus() external onlyOwner {
        require(metaverseAccessContract != address(0), "First get the Metaverse ready");
        isBurningActive = !isBurningActive;
    }

    function toggleProxyToApproved(address proxyAddress) external onlyOwner {
        proxyToApproved[proxyAddress] = !proxyToApproved[proxyAddress];
    }

    function setRoyaltyFeeBasisPoints(uint96 royaltyFeeBasisPoints_) external onlyOwner {
        royaltyFeeBasisPoints = royaltyFeeBasisPoints_;
        _setDefaultRoyalty(owner(), royaltyFeeBasisPoints_);
    }

    function setReferrerEarningBasisPoints(uint96 referrerEarningBasisPoints_) external onlyOwner {
        referrerEarningBasisPoints = referrerEarningBasisPoints_;
    }

    function setPrivilegedMintSignerAddress(address privilegedMintSignerAddress_) external onlyOwner {
        privilegedMintSignerAddress = privilegedMintSignerAddress_;
    }

    function setReferralMintSignerAddress(address referralMintSignerAddress_) external onlyOwner {
        referralMintSignerAddress = referralMintSignerAddress_;
    }

    function setPublicMintPrice(uint256 publicMintPrice_) external onlyOwner {
        publicMintPrice = publicMintPrice_;
    }

    function setMinreferralMintPrice(uint256 minReferralMintPrice_) external onlyOwner {
        minReferralMintPrice = minReferralMintPrice_;
    }

    function setReferralStruct(string memory Struct) external onlyOwner {
        referralStruct = Struct;
    }

    function setPrivilegedStruct(string memory Struct) external onlyOwner {
        privilegedStruct = Struct;
    }

    function setMetaverseAccessContract(address metaverseAccessContract_) external onlyOwner {
        metaverseAccessContract = metaverseAccessContract_;
    }

    function supportsInterface(bytes4 interfaceId)
        public
        view
        virtual
        override(ERC721A, ERC2981)
        returns (bool)
    {
        return super.supportsInterface(interfaceId);
    }

    function withdrawFunds() external onlyOwner {
        (bool success, bytes memory returnData) = payable(owner()).call{
                value: address(this).balance
            }("");
        require(success, string(returnData));
    }

    function isApprovedForAll(address _owner, address operator) public view virtual override returns(bool) {
        OpenSeaProxyRegistry proxyRegistry = OpenSeaProxyRegistry(openSeaProxyRegistryAddress);
        if (proxyToApproved[operator] || address(proxyRegistry.proxies(_owner)) == operator)
        return true;

        return super.isApprovedForAll(_owner, operator);
    }

    receive() external payable {}

}